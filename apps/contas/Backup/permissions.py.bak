from functools import wraps
from django.shortcuts import redirect
from django.contrib import messages
from django.contrib.auth.decorators import login_required

from backend.apps.apps.contas.models import UserRole, RolePermission


def usuario_tem_permissao(usuario, codigo_perm):
    """
    Retorna True se o usuário tiver a permissão pelo RBAC.
    """
    if usuario.is_superuser or getattr(usuario, "is_master", False):
        return True

    papeis = UserRole.objects.filter(user=usuario).values_list("role_id", flat=True)
    if not papeis:
        return False

    permissoes = RolePermission.objects.filter(role_id__in=papeis).values_list(
        "codigo", flat=True
    )

    return codigo_perm in permissoes


def has_perm(codigo):
    """
    Decorador: @has_perm("documento.aprovar")
    """
    def decorator(view_func):
        @wraps(view_func)
        @login_required
        def wrapper(request, *args, **kwargs):
            if usuario_tem_permissao(request.user, codigo):
                return view_func(request, *args, **kwargs)

            messages.error(request, "Você não tem permissão para acessar esta função.")
            return redirect("documentos:listar_documentos")

        return wrapper

    return decorator
