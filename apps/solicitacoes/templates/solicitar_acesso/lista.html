{% extends "documentos/base.html" %}
{% load static %}

{% block title %}Solicitações de Acesso{% endblock %}

{# URLs resolvidas com "as" para não quebrar se a rota mudar #}
{% url 'solicitacoes:solicitar_acesso' as url_nova_solicitacao %}
{% url 'solicitacoes:listar_solicitacoes' as url_lista %}

{% block content %}
<div class="container-fluid py-3 page-solicitacoes">

  {# Selo de debug para você confirmar que ESTE template está carregando #}
  {% if debug %}
    <div style="position:fixed;bottom:12px;right:12px;z-index:999999;
                background:#e11d48;color:#fff;padding:8px 12px;border-radius:999px;
                font-weight:900;">
      SOLICITAÇÕES · LISTA · v2
    </div>
  {% endif %}

  <div class="dash-header">
    <div>
      <h1 class="dash-title">Solicitações de Acesso</h1>
      <div class="dash-subtitle">
        Análise e tratamento de solicitações (somente staff).
        {% if solicitacoes %}
          · Total: {{ solicitacoes|length }}
        {% endif %}
      </div>
    </div>

    <div class="d-flex gap-2 flex-wrap">
      <a class="dash-btn dash-btn-primary" href="{{ url_nova_solicitacao|default:'/solicitar/' }}">
        <i class="bi bi-plus-circle"></i> Nova solicitação
      </a>

      <a class="dash-btn" href="{{ url_lista|default:'/solicitar/lista/' }}">
        <i class="bi bi-arrow-clockwise"></i> Atualizar
      </a>
    </div>
  </div>

  <div class="dash-surface p-0 solicitacoes-surface">
    <div class="table-responsive solicitacoes-table-wrap">
      <table class="table table-hover table-sm align-middle dash-table solicitacoes-table">
        <thead>
          <tr>
            <th style="min-width:200px;">Nome</th>
            <th style="min-width:240px;">E-mail</th>
            <th style="min-width:140px;">Setor</th>
            <th style="min-width:140px;">Status</th>
            <th style="min-width:170px;">Data</th>
            <th class="text-end" style="min-width:130px;">Ações</th>
          </tr>
        </thead>

        <tbody>
          {% for s in solicitacoes %}
            {% url 'solicitacoes:detalhe_solicitacao' s.id as url_detalhe %}
            <tr>
              <td class="fw-semibold">{{ s.nome|default:"-" }}</td>
              <td>{{ s.email|default:"-" }}</td>
              <td>{% if s.setor %}{{ s.setor }}{% else %}-{% endif %}</td>

              <td>
                {% with st=s.get_status_display|default:s.status %}
                  {% with stl=st|lower %}
                    <span class="dash-badge
                      {% if 'aprov' in stl %}dash-badge-success
                      {% elif 'neg' in stl %}dash-badge-danger
                      {% elif 'pend' in stl or 'aguard' in stl %}dash-badge-warning
                      {% else %}dash-badge-info{% endif %}">
                      <i class="bi bi-shield-check"></i> {{ st|default:"-" }}
                    </span>
                  {% endwith %}
                {% endwith %}
              </td>

              <td>
                {% if s.data_solicitacao %}
                  {{ s.data_solicitacao|date:"d/m/Y H:i" }}
                {% elif s.data %}
                  {{ s.data|date:"d/m/Y H:i" }}
                {% else %}
                  -
                {% endif %}
              </td>

              <td class="text-end">
                <a href="{{ url_detalhe|default:'#' }}" class="dash-btn dash-btn-primary">
                  <i class="bi bi-box-arrow-in-right"></i> Abrir
                </a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="text-center py-4" style="color:var(--dash-muted);">
                Nenhuma solicitação encontrada.
              </td>
            </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>
  </div>

</div>
{% endblock %}
