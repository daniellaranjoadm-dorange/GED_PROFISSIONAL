{% extends "documentos/base.html" %}
{% load static %}

{% block title %}Dashboard Â· D'ORANGE PLATFORM{% endblock %}

{% block extra_head %}
<style>
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(240px,1fr));
    gap: 1.2rem;
    margin-bottom: 1.5rem;
}

.card-kpi {
    background: var(--bg-card);
    border: 1px solid var(--border);
    box-shadow: 0 3px 10px var(--shadow);
    border-radius: 14px;
    padding: 1.3rem 1.5rem;
    transition: .2s;
}
.card-kpi:hover { transform: translateY(-3px); }

.card-kpi .value {
    font-size: 1.9rem;
    font-weight: bold;
    color: var(--accent-blue);
}
.card-kpi .label {
    font-size: .9rem;
    font-weight: 500;
    color: var(--text-soft);
}
.card-kpi i { font-size: 26px; margin-right: 6px; }

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 1rem 0 .6rem 0;
    color: var(--accent-blue);
}

/* Grids horizontais */
.chart-box {
    background: var(--bg-card);
    padding: 1.2rem;
    border-radius: 14px;
    border: 1px solid var(--border);
    box-shadow: 0 3px 10px var(--shadow);
}

.table-box {
    background: var(--bg-card);
    border-radius: 12px;
    border: 1px solid var(--border);
    padding: 1rem;
    box-shadow: 0 3px 10px var(--shadow);
}
.table-title {
    font-weight: 600;
    margin-bottom: .6rem;
}

/* labels status */
.badge-aprovado  { background:#059669!important; }
.badge-negado    { background:#dc2626!important; }
.badge-pendente  { background:#eab308!important;color:#000!important; }

</style>
{% endblock %}

{% block content %}

<div class="ds-page">
  <div class="ds-pagehead">
    <div>
      <h1 class="ds-title">ðŸ“Š Dashboard</h1>
      <p class="ds-subtitle">VisÃ£o geral do GED.</p>
    </div>
  </div>

  <div class="ds-surface">
<div class="page-title mb-3">
    <div class="page-title-icon"><i class="bi bi-speedometer"></i></div>
    <div class="page-title-text">Dashboard â€“ <strong>D'ORANGE PLATFORM</strong></div>
</div>

<!-- ===========================
     KPIs SolicitaÃ§Ãµes
=========================== -->

<h5 class="section-title">ðŸ“¥ SolicitaÃ§Ãµes de Acesso</h5>

<div class="dashboard-grid">

    <div class="card-kpi"><span class="value">{{ kpi_total }}</span><br><span class="label"><i class="bi bi-people"></i> Total</span></div>
    <div class="card-kpi"><span class="value">{{ kpi_pendentes }}</span><br><span class="label"><i class="bi bi-clock-history"></i> Pendentes</span></div>
    <div class="card-kpi"><span class="value">{{ kpi_aprovadas }}</span><br><span class="label"><i class="bi bi-check-circle"></i> Aprovadas</span></div>
    <div class="card-kpi"><span class="value">{{ kpi_negadas }}</span><br><span class="label"><i class="bi bi-x-circle"></i> Negadas</span></div>
    <div class="card-kpi"><span class="value">{{ kpi_taxa_aprovacao }}%</span><br><span class="label"><i class="bi bi-graph-up-arrow"></i> Taxa de AprovaÃ§Ã£o</span></div>

</div>

<div class="dashboard-grid">

    <div class="chart-box">
        <canvas id="chartStatus"></canvas>
    </div>

    <div class="chart-box">
        <canvas id="chartMes"></canvas>
    </div>

    <div class="chart-box">
        <canvas id="chartSetor"></canvas>
    </div>

</div>

<!-- ===========================
     KPIs Documentos (GED)
=========================== -->

<h5 class="section-title mt-4">ðŸ“„ GED â€“ Documentos</h5>

<div class="dashboard-grid">
    <div class="card-kpi"><span class="value">{{ doc_total }}</span><br><span class="label"><i class="bi bi-journal-bookmark"></i> Documentos</span></div>
    <div class="card-kpi"><span class="value">{{ doc_em_revisao }}</span><br><span class="label">Em RevisÃ£o</span></div>
    <div class="card-kpi"><span class="value">{{ doc_aprovados }}</span><br><span class="label">Aprovados</span></div>
    <div class="card-kpi"><span class="value">{{ doc_emitidos }}</span><br><span class="label">Emitidos</span></div>
    <div class="card-kpi"><span class="value">{{ doc_cancelados }}</span><br><span class="label">Cancelados</span></div>
</div>

<div class="dashboard-grid">

    <div class="chart-box">
        <canvas id="chartDocsStatus"></canvas>
    </div>

    <div class="chart-box">
        <canvas id="chartDocsDisciplina"></canvas>
    </div>

    <div class="chart-box">
        <canvas id="chartDocsMes"></canvas>
    </div>

</div>

<!-- ===========================
     Listas rÃ¡pidas
=========================== -->

<h5 class="section-title">ðŸ”Ž Ãšltimas atualizaÃ§Ãµes</h5>

<div class="row g-3">

    <div class="col-lg-6">
        <div class="table-box">
            <div class="table-title">Ãšltimos Documentos</div>
            <table class="table table-sm">
                {% for d in ultimos_docs %}
                <tr>
                    <td><strong>{{ d.codigo }}</strong></td>
                    <td>{{ d.titulo|truncatechars:40 }}</td>
                    <td>{{ d.criado_em|date:"d/m/Y" }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="table-box">
            <div class="table-title">RevisÃµes Recentes</div>
            <table class="table table-sm">
                {% for r in ultimas_revisoes %}
                <tr>
                    <td><strong>{{ r.documento.codigo }}</strong></td>
                    <td>Rev {{ r.numero_revisao }}</td>
                    <td>{{ r.criado_em|date:"d/m/Y" }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>

</div>


  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function renderChart(id, labels, data, title){
    new Chart(document.getElementById(id), {
        type:'bar',
        data:{labels:JSON.parse(labels), datasets:[{data:JSON.parse(data)}]},
    });
}

renderChart("chartStatus", "{{ chart_status_labels }}", "{{ chart_status_data }}");
renderChart("chartMes", "{{ chart_mes_labels }}", "{{ chart_mes_data }}");
renderChart("chartSetor", "{{ chart_setor_labels }}", "{{ chart_setor_data }}");

renderChart("chartDocsStatus", "{{ chart_docs_status_labels }}", "{{ chart_docs_status_data }}");
renderChart("chartDocsDisciplina", "{{ chart_docs_disciplina_labels }}", "{{ chart_docs_disciplina_data }}");
renderChart("chartDocsMes", "{{ chart_docs_mes_labels }}", "{{ chart_docs_mes_data }}");
</script>
{% endblock %}
