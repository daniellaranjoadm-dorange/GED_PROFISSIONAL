from django.shortcuts import render, redirect, get_object_or_404
from django.core.files.storage import default_storage
from django.contrib.auth import authenticate, login, logout
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.db.models import Count, Q
from django.utils import timezone
from django.http import HttpResponse, JsonResponse
from datetime import date, datetime
from io import BytesIO
import json
import os
import re

import csv

import openpyxl
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from openpyxl.utils import get_column_letter

# =================================================================
# IMPORTS - CONTAS APP
# =================================================================
from backend.apps.apps.contas.permissions import has_perm
from backend.apps.apps.contas.decorators import allow_admin

# =================================================================
# IMPORTS - DOCUMENTOS APP
# =================================================================
from .models import Documento, ArquivoDocumento
from .utils_email import enviar_email


# =================================================================
# CONFIG GLOBAL
# =================================================================

VALOR_MEDICAO_USD = 979.00
TAXA_CAMBIO_REAIS = 5.76

REVISOES_VALIDAS = [
    "0",
    "A","B","C","D","E","F","G","H",
    "J","K","L","M","N","P","Q","R",
    "S","T","U","V","W","X","Y","Z",
    "AA","AB","AC","AD","AE","AF","AG","AH",
    "AJ","AK"
]


# =================================================================
# FUNÇÕES AUXILIARES
# =================================================================

def normalizar_revisao(rev_bruto):
    """Normaliza revisões e valida formatos aceitos."""
    if rev_bruto is None:
        return ""

    rev = str(rev_bruto).strip().upper()

    if rev == "":
        return ""
    if rev == "0":
        return "0"
    if rev.isdigit():
        return None
    if any(ch.isdigit() for ch in rev):
        return None

    if rev.startswith("R") and rev[1:].isalpha():
        return rev[1:]

    return rev if rev.isalpha() else None


def registrar_workflow(documento, etapa, status, request, observacao=""):
    """Adiciona uma entrada no workflow do documento."""
    ip = request.META.get("HTTP_X_FORWARDED_FOR")
    ip = ip.split(",")[0].strip() if ip else request.META.get("REMOTE_ADDR", "")
    user_agent = request.META.get("HTTP_USER_AGENT", "")
    meta = f"IP: {ip} | UA: {user_agent[:150]}"
    obs_final = f"{observacao} | {meta}" if observacao else meta

    usuario = request.user.username if request.user.is_authenticated else "Sistema"

    WorkflowDocumento.objects.create(
        documento=documento,
        etapa=etapa,
        status=status,
        usuario=usuario,
        observacao=obs_final,
    )


def notificar_evento_documento(documento, tipo_evento):
    """Centraliza notificações por e-mail."""
    assunto = ""
    mensagem = ""

    if tipo_evento == "envio_revisao":
        assunto = f"Documento em Revisão: {documento.codigo}"
        mensagem = f"O documento {documento.codigo} (Rev {documento.revisao}) foi enviado para revisão."
    elif tipo_evento == "aprovacao":
        assunto = f"Documento Aprovado: {documento.codigo}"
        mensagem = f"O documento {documento.codigo} (Rev {documento.revisao}) foi aprovado."
    elif tipo_evento == "emissao":
        assunto = f"Documento Emitido: {documento.codigo}"
        mensagem = (
            f"O documento {documento.codigo} (Rev {documento.revisao}) "
            f"foi emitido em {documento.data_emissao_tp}."
        )
    elif tipo_evento == "cancelamento":
        assunto = f"Documento Cancelado: {documento.codigo}"
        mensagem = f"O documento {documento.codigo} (Rev {documento.revisao}) foi cancelado."
    else:
        return

    try:
        enviar_email(
            assunto=assunto,
            mensagem=mensagem,
            destinatarios=["seu.email@empresa.com"],
        )
    except:
        pass  # nunca quebrar fluxo por causa de email


def mover_para_lixeira(documento, request, etapa="Exclusão", motivo=""):
    """Soft delete."""
    if not documento.ativo:
        return False

    documento.ativo = False
    documento.deletado_em = timezone.now()
    documento.deletado_por = request.user.username
    documento.motivo_exclusao = motivo or ""
    documento.save()

    registrar_workflow(documento, etapa, "Excluído", request, motivo)
    return True


def restaurar_da_lixeira(documento, request):
    documento.ativo = True
    documento.deletado_em = None
    documento.deletado_por = None
    documento.motivo_exclusao = ""
    documento.save()

    registrar_workflow(documento, "Restauração", "Restaurado", request)


def highlight_text(texto, termo):
    """Destaca termo com <mark> (case-insensitive)."""
    if not texto or not termo:
        return texto or ""

    regex = re.compile(re.escape(termo), re.IGNORECASE)

    def repl(match):
        return f"<mark style='background:#ffeb3b; padding:2px; border-radius:4px;'>{match.group(0)}</mark>"

    return regex.sub(repl, texto)
# =================================================================
# LOGIN / LOGOUT
# =================================================================

def login_view(request):
    if request.method == "POST":
        user = authenticate(
            request,
            username=request.POST.get("username"),
            password=request.POST.get("password"),
        )
        if user:
            login(request, user)
            return redirect("documentos:listar_documentos")

        return render(
            request,
            "contas/login.html",   # 🔥 TEMPLATE CORRETO
            {"erro": "Usuário ou senha incorretos."},
        )

    # GET
    return render(request, "contas/login.html")  # 🔥 TEMPLATE CORRETO


def logout_view(request):
    logout(request)
    return redirect("contas:login")

# =================================================================
# DASHBOARD SIMPLES
# =================================================================

@login_required
def dashboard(request):
    docs = Documento.objects.filter(ativo=True)

    total_docs = docs.count()
    total_aprovados = docs.filter(status_ldp="Aprovado").count()
    total_em_revisao = docs.filter(status_ldp="Em Revisão").count()
    total_emitidos = docs.filter(status_emissao="Emitido").count()
    total_nao_recebidos = docs.filter(status_emissao="Não Recebido").count()

    valor_emitidos_usd = total_emitidos * VALOR_MEDICAO_USD
    valor_nao_rec_usd = total_nao_recebidos * VALOR_MEDICAO_USD

    valor_total_usd = valor_emitidos_usd + valor_nao_rec_usd

    return render(
        request,
        "documentos/dashboard.html",
        {
            "total_docs": total_docs,
            "total_aprovados": total_aprovados,
            "total_em_revisao": total_em_revisao,
            "total_emitidos": total_emitidos,
            "total_nao_recebidos": total_nao_recebidos,
            "valor_total_usd": f"{valor_total_usd:,.2f}",
        },
    )

# =================================================================
# DASHBOARD ENTERPRISE (COMPLETO)
# =================================================================

@login_required
@has_perm("sistema.dashboard_enterprise")   # você pode mudar isso depois
def dashboard_enterprise(request):
    docs = Documento.objects.filter(ativo=True)

    # ============================
    # Coleta de FILTROS
    # ============================
    filtros = {
        "projeto": request.GET.get("projeto") or "",
        "disciplina": request.GET.get("disciplina") or "",
        "tipo_doc": request.GET.get("tipo_doc") or "",
        "status_ldp": request.GET.get("status_ldp") or "",
        "status_emissao": request.GET.get("status_emissao") or "",
        "dt_ini": request.GET.get("dt_ini") or "",
        "dt_fim": request.GET.get("dt_fim") or "",
    }

    # ============================
    # Aplicação dos Filtros
    # ============================
    if filtros["projeto"]:
        docs = docs.filter(projeto__icontains=filtros["projeto"])

    if filtros["disciplina"]:
        docs = docs.filter(disciplina=filtros["disciplina"])

    if filtros["tipo_doc"]:
        docs = docs.filter(tipo_doc=filtros["tipo_doc"])

    if filtros["status_ldp"]:
        docs = docs.filter(status_ldp=filtros["status_ldp"])

    if filtros["status_emissao"]:
        docs = docs.filter(status_emissao=filtros["status_emissao"])

    if filtros["dt_ini"]:
        dt_ini = datetime.strptime(filtros["dt_ini"], "%Y-%m-%d").date()
        docs = docs.filter(data_emissao_tp__gte=dt_ini)

    if filtros["dt_fim"]:
        dt_fim = datetime.strptime(filtros["dt_fim"], "%Y-%m-%d").date()
        docs = docs.filter(data_emissao_tp__lte=dt_fim)

    # ============================
    # KPIs
    # ============================
    total_docs = docs.count()
    total_emitidos = docs.filter(status_emissao="Emitido").count()
    total_nao_recebidos = docs.filter(status_emissao="Não Recebido").count()
    total_em_revisao = docs.filter(status_ldp="Em Revisão").count()
    total_aprovados = docs.filter(status_ldp="Aprovado").count()

    valor_emitidos_usd = total_emitidos * VALOR_MEDICAO_USD
    valor_nao_rec_usd = total_nao_recebidos * VALOR_MEDICAO_USD
    valor_total_usd = valor_emitidos_usd + valor_nao_rec_usd

    valor_emitidos_brl = valor_emitidos_usd * TAXA_CAMBIO_REAIS
    valor_nao_rec_brl = valor_nao_rec_usd * TAXA_CAMBIO_REAIS
    valor_total_brl = valor_emitidos_brl + valor_nao_rec_brl

    # ============================
    # Dados para Gráficos
    # ============================
    por_disc = docs.values("disciplina").annotate(qtd=Count("id"))
    disc_labels = [d["disciplina"] for d in por_disc]
    disc_data = [d["qtd"] for d in por_disc]

    por_status = docs.values("status_ldp").annotate(qtd=Count("id"))
    status_labels = [d["status_ldp"] or "Sem Status" for d in por_status]
    status_data = [d["qtd"] for d in por_status]

    # ============================
    # Medição Detalhada (tabela)
    # ============================
    med_raw = docs.values("tipo_doc").annotate(
        total=Count("id"),
        emitidos=Count("id", filter=Q(status_emissao="Emitido")),
        nr=Count("id", filter=Q(status_emissao="Não Recebido")),
    )

    medicao_linhas = []
    total_usd = 0
    total_brl = 0

    for m in med_raw:
        tipo = m["tipo_doc"] or "Sem Tipo"
        emit = m["emitidos"]
        nr = m["nr"]

        v_emit_usd = emit * VALOR_MEDICAO_USD
        v_nr_usd = nr * VALOR_MEDICAO_USD
        v_emit_brl = v_emit_usd * TAXA_CAMBIO_REAIS
        v_nr_brl = v_nr_usd * TAXA_CAMBIO_REAIS

        total_usd += v_emit_usd + v_nr_usd
        total_brl += v_emit_brl + v_nr_brl

        medicao_linhas.append({
            "tipo_doc": tipo,
            "total": m["total"],
            "emitidos": emit,
            "nao_recebidos": nr,
            "valor_emitidos_usd": f"{v_emit_usd:,.2f}",
            "valor_nr_usd": f"{v_nr_usd:,.2f}",
            "valor_emitidos_brl": f"{v_emit_brl:,.2f}",
            "valor_nr_brl": f"{v_nr_brl:,.2f}",
        })

    medicao_totais = {
        "total_docs": sum(m["total"] for m in med_raw),
        "total_usd": f"{total_usd:,.2f}",
        "total_brl": f"{total_brl:,.2f}",
    }

    # Listas para selects
    base_qs = Documento.objects.filter(ativo=True)

    return render(
        request,
        "documentos/dashboard_enterprise.html",
        {
            "filtros": filtros,
            "total_docs": total_docs,
            "total_emitidos": total_emitidos,
            "total_nao_recebidos": total_nao_recebidos,
            "total_em_revisao": total_em_revisao,
            "total_aprovados": total_aprovados,
            "valor_emitidos_usd": f"{valor_emitidos_usd:,.2f}",
            "valor_emitidos_brl": f"{valor_emitidos_brl:,.2f}",
            "valor_nao_rec_usd": f"{valor_nao_rec_usd:,.2f}",
            "valor_nao_rec_brl": f"{valor_nao_rec_brl:,.2f}",
            "valor_total_usd": f"{valor_total_usd:,.2f}",
            "valor_total_brl": f"{valor_total_brl:,.2f}",
            "disc_labels": json.dumps(disc_labels),
            "disc_data": json.dumps(disc_data),
            "status_labels": json.dumps(status_labels),
            "status_data": json.dumps(status_data),
            "medicao_linhas": medicao_linhas,
            "medicao_totais": medicao_totais,
            "lista_projetos": base_qs.values_list("projeto", flat=True).distinct(),
            "lista_disciplinas": base_qs.values_list("disciplina", flat=True).distinct(),
            "lista_tipos": base_qs.values_list("tipo_doc", flat=True).distinct(),
            "lista_status_ldp": base_qs.values_list("status_ldp", flat=True).distinct(),
            "lista_status_emissao": base_qs.values_list("status_emissao", flat=True).distinct(),
        },
    )
# =================================================================
# PAINEL DE WORKFLOW (VISÃO GERAL)
# =================================================================

@login_required
def painel_workflow(request):

    # Base: somente documentos ativos
    docs_base = Documento.objects.filter(ativo=True)

    # =====================
    # FILTROS RECEBIDOS
    # =====================
    etapa_filtro = request.GET.get("etapa") or ""
    disciplina_filtro = request.GET.get("disciplina") or ""
    projeto_filtro = request.GET.get("projeto") or ""
    status_ldp_filtro = request.GET.get("status_ldp") or ""
    status_emissao_filtro = request.GET.get("status_emissao") or ""

    # =====================
    # APLICAÇÃO DOS FILTROS
    # =====================
    docs = docs_base

    if etapa_filtro:
        docs = docs.filter(etapa_atual=etapa_filtro)

    if disciplina_filtro:
        docs = docs.filter(disciplina=disciplina_filtro)

    if projeto_filtro:
        docs = docs.filter(projeto=projeto_filtro)

    if status_ldp_filtro:
        docs = docs.filter(status_ldp=status_ldp_filtro)

    if status_emissao_filtro:
        docs = docs.filter(status_emissao=status_emissao_filtro)

    # =====================
    # ORDENAÇÃO
    # =====================
    order = request.GET.get("order") or ""
    direction = request.GET.get("direction") or "asc"

    valid_fields = {
        "codigo": "codigo",
        "titulo": "titulo",
        "disciplina": "disciplina",
        "projeto": "projeto",
        "etapa_atual": "etapa_atual",
        "status_ldp": "status_ldp",
        "status_emissao": "status_emissao",
        "revisao": "revisao",
    }

    if order in valid_fields:
        field = valid_fields[order]
        if direction == "desc":
            field = "-" + field
        docs = docs.order_by(field)
    else:
        docs = docs.order_by("etapa_atual", "codigo")

    # =====================
    # LISTAS PARA OS SELECTS
    # =====================
    disciplinas = (
        docs_base.exclude(disciplina__isnull=True)
        .exclude(disciplina__exact="")
        .values_list("disciplina", flat=True)
        .distinct()
        .order_by("disciplina")
    )

    projetos = (
        docs_base.exclude(projeto__isnull=True)
        .exclude(projeto__exact="")
        .values_list("projeto", flat=True)
        .distinct()
        .order_by("projeto")
    )

    status_ldp_lista = (
        docs_base.exclude(status_ldp__isnull=True)
        .exclude(status_ldp__exact="")
        .values_list("status_ldp", flat=True)
        .distinct()
        .order_by("status_ldp")
    )

    status_emissao_lista = (
        docs_base.exclude(status_emissao__isnull=True)
        .exclude(status_emissao__exact="")
        .values_list("status_emissao", flat=True)
        .distinct()
        .order_by("status_emissao")
    )

    # =====================
    # PAGINAÇÃO
    # =====================
    from django.core.paginator import Paginator

    per_page = request.GET.get("per_page") or 25
    try:
        per_page = int(per_page)
    except:
        per_page = 25

    total_filtrados = docs.count()

    paginator = Paginator(docs, per_page)
    page_number = request.GET.get("page")
    page_obj = paginator.get_page(page_number)
    documentos = page_obj

    # =====================
    # KPIs POR ETAPA
    # =====================
    por_etapa_qs = (
        docs_base
        .values("etapa_atual")
        .annotate(qtd=Count("id"))
    )

    mapa_etapas = {row["etapa_atual"] or "Sem etapa": row["qtd"] for row in por_etapa_qs}

    etapas_kpi = []

    for nome in ETAPAS_WORKFLOW:

        # URL clicável mantendo filtros
        url = (
            f"?etapa={nome}"
            f"&disciplina={disciplina_filtro}"
            f"&projeto={projeto_filtro}"
            f"&status_ldp={status_ldp_filtro}"
            f"&status_emissao={status_emissao_filtro}"
            f"&order={order}"
            f"&direction={direction}"
            f"&per_page={per_page}"
        )

        etapas_kpi.append({
            "nome": nome,
            "qtd": mapa_etapas.get(nome, 0),
            "url": url,
        })

    # KPI extra
    url_sem_etapa = (
        f"?etapa=Sem%20etapa"
        f"&disciplina={disciplina_filtro}"
        f"&projeto={projeto_filtro}"
        f"&status_ldp={status_ldp_filtro}"
        f"&status_emissao={status_emissao_filtro}"
        f"&order={order}"
        f"&direction={direction}"
        f"&per_page={per_page}"
    )

    etapas_kpi.append({
        "nome": "Sem etapa definida",
        "qtd": mapa_etapas.get("Sem etapa", mapa_etapas.get(None, 0)),
        "url": url_sem_etapa,
    })

    # =====================
    # ÚLTIMOS MOVIMENTOS
    # =====================
    ultimos_movimentos = (
        WorkflowDocumento.objects
        .select_related("documento")
        .order_by("-data")[:20]
    )

    # =====================
    # RENDER
    # =====================
    return render(
        request,
        "documentos/painel_workflow.html",
        {
            "documentos": documentos,
            "page_obj": page_obj,
            "per_page": per_page,
            "total_docs": total_filtrados,

            "order": order,
            "direction": direction,

            "etapas_kpi": etapas_kpi,
            "etapas_workflow": ETAPAS_WORKFLOW,
            "etapa_filtro": etapa_filtro,

            "disciplinas": disciplinas,
            "disciplina_filtro": disciplina_filtro,

            "projetos": projetos,
            "projeto_filtro": projeto_filtro,

            "status_ldp_lista": status_ldp_lista,
            "status_ldp_filtro": status_ldp_filtro,

            "status_emissao_lista": status_emissao_lista,
            "status_emissao_filtro": status_emissao_filtro,

            "ultimos_movimentos": ultimos_movimentos,
        },
    )

 
# =================================================================
# EXPORTAR EXCEL DO PAINEL
# =================================================================
@login_required
def painel_workflow_exportar_excel(request):
    # Recebe filtros
    etapa = request.GET.get("etapa") or ""
    disciplina = request.GET.get("disciplina") or ""
    projeto = request.GET.get("projeto") or ""
    status_ldp = request.GET.get("status_ldp") or ""
    status_emissao = request.GET.get("status_emissao") or ""

    # Query base
    docs = Documento.objects.filter(ativo=True)

    # Filtros aplicados
    if etapa:
        docs = docs.filter(etapa_atual=etapa)
    if disciplina:
        docs = docs.filter(disciplina=disciplina)
    if projeto:
        docs = docs.filter(projeto=projeto)
    if status_ldp:
        docs = docs.filter(status_ldp=status_ldp)
    if status_emissao:
        docs = docs.filter(status_emissao=status_emissao)

    # ============================================================
    # CRIAÇÃO DO ARQUIVO XLSX
    # ============================================================
    wb = openpyxl.Workbook()
    ws = wb.active
    ws.title = "Workflow GED"

    # Cabeçalho
    headers = [
        "Código",
        "Revisão",
        "Título",
        "Disciplina",
        "Projeto",
        "Etapa Atual",
        "Status LDP",
        "Status Emissão",
    ]
    ws.append(headers)

    # Estilização do cabeçalho
    header_fill = PatternFill(start_color="0052A2", end_color="0052A2", fill_type="solid")
    border = Border(
        left=Side(style="thin"),
        right=Side(style="thin"),
        top=Side(style="thin"),
        bottom=Side(style="thin")
    )

    for col in ws[1]:
        col.fill = header_fill
        col.font = Font(color="FFFFFF", bold=True)
        col.border = border
        col.alignment = Alignment(horizontal="center")

    # Preenchimento das linhas
    for d in docs:
        ws.append([
            d.codigo or "",
            d.revisao or "",
            d.titulo or "",
            d.disciplina or "",
            d.projeto or "",
            d.etapa_atual or "",
            d.status_ldp or "",
            d.status_emissao or "",
        ])

    # Auto-ajuste das colunas
    for column_cells in ws.columns:
        length = max(len(str(cell.value)) if cell.value else 0 for cell in column_cells)
        ws.column_dimensions[column_cells[0].column_letter].width = length + 3

    # Exportação
    output = BytesIO()
    wb.save(output)
    output.seek(0)

    filename = f"workflow_{date.today().isoformat()}.xlsx"

    return HttpResponse(
        output.getvalue(),
        content_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        headers={"Content-Disposition": f'attachment; filename="{filename}"'},
    )

# =================================================================
# LISTAR DOCUMENTOS
# =================================================================

@login_required
def listar_documentos(request):
    docs = Documento.objects.filter(ativo=True).order_by("-criado_em")

    # FILTROS
    projeto = request.GET.get("projeto") or ""
    disciplina = request.GET.get("disciplina") or ""
    status_ldp = request.GET.get("status_ldp") or ""
    status_emissao = request.GET.get("status_emissao") or ""
    busca = request.GET.get("busca") or ""

    if projeto:
        docs = docs.filter(projeto__icontains=projeto)
    if disciplina:
        docs = docs.filter(disciplina=disciplina)
    if status_ldp:
        docs = docs.filter(status_ldp=status_ldp)
    if status_emissao:
        docs = docs.filter(status_emissao=status_emissao)
    if busca:
        docs = docs.filter(Q(titulo__icontains=busca) | Q(codigo__icontains=busca))

    base_qs = Documento.objects.filter(ativo=True)

    filtros_ativos = {
        "projeto": projeto,
        "disciplina": disciplina,
        "status_ldp": status_ldp,
        "status_emissao": status_emissao,
        "busca": busca,
    }

    ha_filtros = any(filtros_ativos.values())

    return render(
        request,
        "documentos/listar.html",
        {
            "documentos": docs,
            "projetos": base_qs.values_list("projeto", flat=True).distinct(),
            "disciplinas": base_qs.values_list("disciplina", flat=True).distinct(),
            "status_ldp_list": base_qs.values_list("status_ldp", flat=True).distinct(),
            "status_emissao_list": base_qs.values_list("status_emissao", flat=True).distinct(),
            "filtros_ativos": filtros_ativos,
            "ha_filtros": ha_filtros,
        },
    )


# =================================================================
# DETALHE DO DOCUMENTO
# =================================================================

from django.contrib.auth.models import Group

ETAPAS_WORKFLOW = [
    "Revisão Interna – Disciplina",
    "Aprovação Técnica – Coordenador",
    "Envio ao Cliente",
    "Aprovação do Cliente",
    "Emissão Final",
]


def usuario_em_grupos(user, grupos):
    """Retorna True se o usuário estiver em qualquer grupo da lista."""
    if not user.is_authenticated:
        return False
    return user.groups.filter(name__in=grupos).exists()


def pode_avancar_etapa(user, documento):
    """Regra oficial do seu workflow."""
    if user.is_superuser:
        return True

    doc_control = usuario_em_grupos(
        user, ["Doc-Control", "DOC CONTROL", "DOC_CONTROL"]
    )

    etapa = documento.etapa_atual or ETAPAS_WORKFLOW[0]

    # 1 - Revisão Interna
    if etapa == "Revisão Interna – Disciplina":
        return (
            doc_control
            or user.groups.filter(name__startswith="REVISORES_").exists()
        )

    # 2 - Aprovação Técnica
    if etapa == "Aprovação Técnica – Coordenador":
        return (
            doc_control
            or user.groups.filter(name__startswith="COORD_").exists()
        )

    # 3 - Envio ao Cliente
    if etapa == "Envio ao Cliente":
        return doc_control

    # 4 - Aprovação do Cliente
    if etapa == "Aprovação do Cliente":
        return doc_control or usuario_em_grupos(user, ["CLIENTE"])

    # 5 - Emissão Final
    if etapa == "Emissão Final":
        return (
            doc_control
            or user.groups.filter(name__startswith="COORD_").exists()
        )

    return False


def proxima_etapa(documento):
    etapa = documento.etapa_atual or ETAPAS_WORKFLOW[0]
    try:
        idx = ETAPAS_WORKFLOW.index(etapa)
    except ValueError:
        return None

    if idx + 1 < len(ETAPAS_WORKFLOW):
        return ETAPAS_WORKFLOW[idx + 1]
    return None
# =====================================================================
# AVANÇAR PARA PRÓXIMA ETAPA DO WORKFLOW
# =====================================================================

@login_required
def enviar_proxima_etapa(request, documento_id):
    documento = get_object_or_404(Documento, id=documento_id)

    # Segurança: se não pode avançar → bloqueia
    if not pode_avancar_etapa(request.user, documento):
        messages.error(request, "Você não tem permissão para avançar esta etapa.")
        return redirect("documentos:detalhes_documento", documento_id=documento.id)

    # Identifica a próxima etapa do fluxo
    prox = proxima_etapa(documento)
    if not prox:
        messages.warning(request, "Este documento já está na última etapa do workflow.")
        return redirect("documentos:detalhes_documento", documento_id=documento.id)

    # Atualiza a etapa atual
    documento.etapa_atual = prox
    documento.save()

    # Histórico
    WorkflowDocumento.objects.create(
        documento=documento,
        etapa=prox,
        status="Avançado",
        usuario=request.user.get_full_name() or request.user.username,
        observacao=f"Documento avançado para: {prox}",
    )

    messages.success(request, f"Documento avançado para a próxima etapa: {prox}")
    return redirect("documentos:detalhes_documento", documento_id=documento.id)


# =====================================================================
# RETORNAR ETAPA DO WORKFLOW
# =====================================================================

@login_required
def retornar_etapa(request, documento_id):
    documento = get_object_or_404(Documento, id=documento_id)

    # Segurança: checa se pode retornar
    if not pode_retornar_etapa(request.user, documento):
        messages.error(request, "Você não tem permissão para retornar esta etapa.")
        return redirect("documentos:detalhes_documento", documento_id=documento.id)

    # Identifica etapa anterior
    etapa_prev = etapa_anterior(documento)
    if not etapa_prev:
        messages.warning(request, "Este documento já está na primeira etapa.")
        return redirect("documentos:detalhes_documento", documento_id=documento.id)

    # Atualiza
    documento.etapa_atual = etapa_prev
    documento.save()

    # Histórico
    WorkflowDocumento.objects.create(
        documento=documento,
        etapa=etapa_prev,
        status="Retornado",
        usuario=request.user.get_full_name() or request.user.username,
        observacao=f"Etapa retornada para: {etapa_prev}",
    )

    messages.success(request, f"Etapa retornada para: {etapa_prev}")
    return redirect("documentos:detalhes_documento", documento_id=documento.id)


# =====================================================================
# FUNÇÃO AUXILIAR — ETAPA ANTERIOR
# =====================================================================

def etapa_anterior(documento):
    etapa = documento.etapa_atual or ETAPAS_WORKFLOW[0]

    try:
        idx = ETAPAS_WORKFLOW.index(etapa)
    except ValueError:
        return None

    if idx > 0:
        return ETAPAS_WORKFLOW[idx - 1]

    return None  # já está na primeira etapa


# =====================================================================
# DETALHE DO DOCUMENTO
# =====================================================================

@login_required
def detalhes_documento(request, documento_id):
    documento = get_object_or_404(Documento, id=documento_id)
    historico = documento.workflow.order_by("-data")
    anexos = documento.arquivos.all()

    # URL absoluta para anexos
    for a in anexos:
        try:
            a.url_absoluta = request.build_absolute_uri(a.arquivo.url)
        except Exception:
            a.url_absoluta = a.arquivo.url

    # Versões
    versoes_qs = documento.versoes.all().order_by("-criado_em")
    versao_atual = versoes_qs.first()

    # Revisão
    rev_atual = str(documento.revisao or "").strip().upper()
    if rev_atual not in REVISOES_VALIDAS:
        rev_atual = "0"

    try:
        idx = REVISOES_VALIDAS.index(rev_atual)
        proxima_revisao = REVISOES_VALIDAS[idx + 1] if idx + 1 < len(REVISOES_VALIDAS) else rev_atual
    except ValueError:
        proxima_revisao = "A"

    # Workflow — dados novos necessários no HTML
    pode = pode_avancar_etapa(request.user, documento)
    prox = proxima_etapa(documento)
    pode_ret = pode_retornar_etapa(request.user, documento)
    etapa_prev = etapa_anterior(documento)

    return render(
        request,
        "documentos/detalhes.html",
        {
            "documento": documento,
            "historico_workflow": historico,
            "anexos": anexos,
            "versoes": versoes_qs,
            "versao_atual": versao_atual,
            "proxima_revisao": proxima_revisao,

            # Novos campos essenciais para o HTML
            "pode_avancar_etapa": pode,
            "proxima_etapa": prox,
            "pode_retornar_etapa": pode_ret,
            "etapa_anterior": etapa_prev,
        },
    )

    # =============================================================
    # PASSO 1 — STATUS DO WORKFLOW (já existia no seu código)
    # =============================================================
    try:
        workflow_status = documento.workflow_status
    except:
        workflow_status = None

    # =============================================================
    # PASSO 2 — PERMISSÕES E PRÓXIMA ETAPA (NOVO)
    # =============================================================
    pode = pode_avancar_etapa(request.user, documento)
    prox = proxima_etapa(documento)

    return render(
        request,
        "documentos/detalhes.html",
        {
            "documento": documento,
            "historico_workflow": historico,
            "anexos": anexos,
            "versoes": versoes_qs,
            "versao_atual": versao_atual,
            "proxima_revisao": proxima_revisao,
            "workflow_status": workflow_status,

            # NOVOS CAMPOS QUE O SEU DETALHES.HTML PRECISA:
            "pode_avancar_etapa": pode,
            "proxima_etapa": prox,
        },
    )
def pode_retornar_etapa(user, documento):
    if user.is_superuser:
        return True

    doc_control = usuario_em_grupos(user, ["Doc-Control", "DOC_CONTROL", "DOC CONTROL"])
    coord = user.groups.filter(name__startswith="COORD_").exists()

    return doc_control or coord

# =================================================================
# NOVA VERSÃO DO DOCUMENTO (MODAL)
# =================================================================
@login_required
def nova_versao(request, documento_id):
    documento = get_object_or_404(Documento, id=documento_id)
    from .models import DocumentoVersao

    # Calcula próxima revisão baseada em REVISOES_VALIDAS
    rev_atual = str(documento.revisao or "").strip().upper()
    if rev_atual not in REVISOES_VALIDAS:
        rev_atual = "0"
    try:
        idx = REVISOES_VALIDAS.index(rev_atual)
        proxima_revisao = REVISOES_VALIDAS[idx + 1] if idx + 1 < len(REVISOES_VALIDAS) else rev_atual
    except ValueError:
        proxima_revisao = "A"

    if request.method == "POST":
        numero_revisao = request.POST.get("numero_revisao", "").strip().upper()
        observacao = request.POST.get("observacao", "").strip()
        arquivo = request.FILES.get("arquivo")

        if not arquivo:
            messages.error(request, "Selecione um arquivo.")
            return redirect("documentos:detalhes_documento", documento_id=documento.id)

        if not numero_revisao:
            numero_revisao = proxima_revisao

        if numero_revisao not in REVISOES_VALIDAS:
            messages.error(request, "Revisão inválida.")
            return redirect("documentos:detalhes_documento", documento_id=documento.id)

        DocumentoVersao.objects.create(
            documento=documento,
            numero_revisao=numero_revisao,
            arquivo=arquivo,
            observacao=observacao,
            criado_por=request.user,
        )

        # Atualiza revisão do documento principal
        documento.revisao = numero_revisao
        documento.save(update_fields=["revisao"])

        registrar_workflow(
            documento,
            etapa="Nova Versão",
            status="Criada",
            request=request,
            observacao=f"Versão {numero_revisao} adicionada."
        )

        messages.success(request, "Nova versão adicionada com sucesso!")
        return redirect("documentos:detalhes_documento", documento_id=documento.id)

    return redirect("documentos:detalhes_documento", documento_id=documento.id)



# =================================================================
# UPLOAD DOCUMENTO (CRIAR) — PERMISSÃO RBAC
# =================================================================

@login_required
@has_perm("documento.criar")
def upload_documento(request):
    if request.method == "POST":
        revisao = normalizar_revisao(request.POST.get("revisao"))
        if revisao is None:
            messages.error(request, "Revisão inválida!")
            return redirect("documentos:upload_documento")

        doc = Documento.objects.create(
            titulo=request.POST.get("titulo"),
            codigo=request.POST.get("codigo"),
            revisao=revisao,
            projeto=request.POST.get("projeto"),
            disciplina=request.POST.get("disciplina"),
            tipo_doc=request.POST.get("tipo_doc"),
        )

        arquivos = request.FILES.getlist("arquivos")
        for arq in arquivos:
            ArquivoDocumento.objects.create(
                documento=doc,
                arquivo=arq,
                nome_original=arq.name,
                tipo=arq.name.split(".")[-1].lower(),
            )

        registrar_workflow(doc, "Criação", "Criado", request)

        messages.success(request, "Documento criado com sucesso!")
        return redirect("documentos:listar_documentos")

    return render(request, "documentos/upload.html")


# =================================================================
# EDITAR DOCUMENTO — PERMISSÃO RBAC
# =================================================================

@login_required
@has_perm("documento.editar")
def editar_documento(request, documento_id):
    documento = get_object_or_404(Documento, id=documento_id)

    if request.method == "POST":
        revisao = normalizar_revisao(request.POST.get("revisao"))
        if revisao is None:
            messages.error(request, "Revisão inválida.")
            return redirect("documentos:editar_documento", documento_id=documento.id)

        for campo in ["projeto", "fase", "tipo_doc", "codigo", "disciplina",
                      "titulo", "status_ldp", "status_emissao",
                      "numero_grdt", "numero_pcf"]:
            setattr(documento, campo, request.POST.get(campo))

        documento.revisao = revisao
        documento.data_emissao_tp = request.POST.get("data_emissao_tp") or None
        documento.save()

        messages.success(request, "Documento atualizado.")
        return redirect("documentos:detalhes_documento", documento_id=documento.id)

    return render(
        request,
        "documentos/editar.html",
        {"documento": documento, "REVISOES_VALIDAS": REVISOES_VALIDAS},
    )


# =================================================================
# NOVA REVISÃO — PERMISSÃO RBAC
# =================================================================

@login_required
@has_perm("documento.revisar")
def nova_revisao(request, documento_id):
    documento = get_object_or_404(Documento, id=documento_id)

    # CALCULA a próxima revisão
    idx = REVISOES_VALIDAS.index(documento.revisao) if documento.revisao in REVISOES_VALIDAS else -1
    nova_rev = REVISOES_VALIDAS[idx + 1] if idx + 1 < len(REVISOES_VALIDAS) else "A"

    if request.method == "POST":

        arquivo = request.FILES.get("arquivo")
        observacao = request.POST.get("observacao", "")

        if not arquivo:
            messages.error(request, "Envie o arquivo da nova revisão.")
            return redirect("documentos:detalhes_documento", documento_id=documento.id)

        # 1️⃣ CRIA O REGISTRO DA NOVA REVISÃO NO HISTÓRICO
        DocumentoVersao.objects.create(
            documento=documento,
            numero_revisao=nova_rev,
            arquivo=arquivo,
            criado_por=request.user,
            observacao=observacao,
            status_revisao="REVISAO",
        )

        # 2️⃣ ATUALIZA A REVISÃO ATUAL DO DOCUMENTO
        documento.revisao = nova_rev
        documento.save(update_fields=["revisao"])

        # 3️⃣ WORKFLOW
        registrar_workflow(documento, "Nova Revisão", "Criado", request)

        messages.success(request, f"Revisão {nova_rev} criada com sucesso!")
        return redirect("documentos:detalhes_documento", documento_id=documento.id)

    return render(
        request,
        "documentos/nova_revisao.html",
        {"documento": documento, "proxima_revisao": nova_rev},
    )

# =================================================================
# UPLOAD DE ANEXOS
# =================================================================

@login_required
def adicionar_arquivos(request, documento_id):
    documento = get_object_or_404(Documento, id=documento_id)

    if request.method == "POST":
        arquivos = request.FILES.getlist("arquivos")

        for arq in arquivos:
            ArquivoDocumento.objects.create(
                documento=documento,
                arquivo=arq,
                nome_original=arq.name,
                tipo=arq.name.split(".")[-1].lower(),
            )

        registrar_workflow(
            documento,
            "Upload de anexos",
            "Arquivos adicionados",
            request,
            observacao=f"{len(arquivos)} arquivos enviados",
        )

        messages.success(request, "Arquivos enviados com sucesso!")
        return redirect("documentos:detalhes_documento", documento_id=documento.id)

    return render(request, "documentos/adicionar_arquivos.html", {"documento": documento})


# =================================================================
# EXCLUIR ARQUIVO INDIVIDUAL
# =================================================================

@login_required
def excluir_arquivo(request, arquivo_id):
    arq = get_object_or_404(ArquivoDocumento, id=arquivo_id)
    documento_id = arq.documento.id

    try:
        default_storage.delete(arq.arquivo.name)
    except:
        pass

    arq.delete()

    messages.success(request, "Arquiv