{% extends "documentos/base.html" %}
{% load static %}

{% block title %}Novo Documento{% endblock %}

{% block content %}
<div class="doc-wrapper">

<style>
/* Fallback: garante o visual premium mesmo se enterprise.css não atualizar (cache/caminho). */
.doc-wrapper .page-area .dash-actions{ display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; }
.doc-wrapper .page-area .dash-input-lg{ padding: 12px 14px !important; font-size: 1.02rem !important; }
.doc-wrapper .page-area .dash-req{ color: var(--dash-accent); font-weight: 900; margin-left: 2px; }
.doc-wrapper .page-area .dash-reqhint{ color: var(--dash-muted); font-size: .78rem; margin-left: 6px; font-weight: 700; }

.doc-wrapper .page-area .dash-dropzone{
  position: relative;
  border-radius: var(--dash-radius);
  border: 2px dashed rgba(148,163,184,.45);
  background: rgba(11,18,32,.03);
  padding: 14px 16px;
  transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
}
body[data-theme="dark"] .doc-wrapper .page-area .dash-dropzone{ background: rgba(0,0,0,.14); border-color: rgba(148,163,184,.30); }
.doc-wrapper .page-area .dash-dropzone:hover{ border-color: rgba(224,96,0,.55); }
.doc-wrapper .page-area .dash-dropzone.is-dragover{
  border-color: rgba(224,96,0,1);
  background: rgba(224,96,0,.08);
  box-shadow: 0 0 0 4px rgba(224,96,0,.12);
}

.doc-wrapper .page-area .dz-title{ font-weight: 900; color: var(--dash-text); display:flex; align-items:center; gap:10px; }
.doc-wrapper .page-area .dz-title i{ color: var(--dash-accent); font-size: 1.1rem; }
.doc-wrapper .page-area .dz-sub{ color: var(--dash-muted); font-weight: 650; margin-top: 2px; }
.doc-wrapper .page-area .dz-meta{ color: var(--dash-muted); font-size: .85rem; margin-top: 6px; }

.doc-wrapper .page-area .dash-filechips{ display:flex; flex-wrap:wrap; gap:8px; margin-top: 10px; }
.doc-wrapper .page-area .dash-chip{
  display:inline-flex; align-items:center; gap:8px;
  padding: 6px 10px; border-radius: 999px;
  border: 1px solid rgba(148,163,184,.28);
  background: rgba(0,0,0,.10);
  max-width: 100%;
}
body[data-theme="light"] .doc-wrapper .page-area .dash-chip{ background: rgba(11,18,32,.05); }
.doc-wrapper .page-area .dash-chip-name{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 42ch; }
.doc-wrapper .page-area .dash-chip-remove{ border:0; background:transparent; padding:0; line-height:1; color: var(--dash-muted); }
.doc-wrapper .page-area .dash-chip-remove:hover{ color: var(--dash-text); }

/* Validation (se Django/Bootstrap aplicar classes) */
.doc-wrapper .page-area .is-invalid{ border-color:#ef4444 !important; box-shadow: 0 0 0 .2rem rgba(239,68,68,.14) !important; }
.doc-wrapper .page-area .is-valid{ border-color:#22c55e !important; box-shadow: 0 0 0 .2rem rgba(34,197,94,.14) !important; }
.doc-wrapper .page-area .invalid-feedback,
.doc-wrapper .page-area .errorlist{ color:#ef4444 !important; font-weight: 650; font-size: .9rem; margin-top: 6px; }
.doc-wrapper .page-area .errorlist{ list-style:none; padding-left:0; margin: 6px 0 0; }
</style>

<div class="d-flex align-items-start justify-content-between gap-3 mb-3">
  <div>
    <h2 class="dash-title">
      <i class="bi bi-file-earmark-plus me-2"></i> Novo Documento
    </h2>
    <div class="dash-subtitle">
      Cadastre um novo documento no GED com os metadados básicos e anexe o(s) arquivo(s).
    </div>
  </div>
  <div class="dash-actions">
    <a href="{% url 'documentos:listar_documentos' %}" class="dash-btn">
      <i class="bi bi-arrow-left"></i> Voltar
    </a>
  </div>
</div>

<div class="dash-surface pad">

  {% if erro %}
    <div class="alert alert-danger d-flex align-items-center gap-2 mb-3" role="alert">
      <i class="bi bi-exclamation-triangle-fill"></i>
      <div>{{ erro }}</div>
    </div>
  {% endif %}

  <form method="POST" enctype="multipart/form-data" action="{% url 'documentos:upload_documento' %}">
    {% csrf_token %}

    <div class="row g-3">

      <div class="col-md-4">
        <label class="form-label">Projeto:</label>
        <select name="projeto" class="form-select">
          <option value="">(sem projeto)</option>
          {% for p in projetos %}
            <option value="{{ p.id }}" {% if request.POST.projeto == p.id|stringformat:"s" %}selected{% endif %}>
              {{ p.nome }}
            </option>
          {% endfor %}
        </select>
        <div class="form-text">Se não selecionar, o sistema pode usar um projeto padrão (se configurado na view).</div>
      </div>

      <div class="col-md-4">
        <label class="form-label">Disciplina:</label>
        <input type="text" name="disciplina" class="form-control"
               placeholder="Ex: CIVIL, ELÉTRICA..."
               value="{{ request.POST.disciplina|default:'' }}">
      </div>

      <div class="col-md-4">
        <label class="form-label">Tipo Documento:</label>
        <input type="text" name="tipo_doc" class="form-control"
               placeholder="Ex: DESENHO, MEMORIAL..."
               value="{{ request.POST.tipo_doc|default:'' }}">
      </div>

      <div class="col-md-4">
        <label class="form-label">Fase:</label>
        <input type="text" name="fase" class="form-control"
               placeholder="Ex: IFC, As Built..."
               value="{{ request.POST.fase|default:'' }}">
      </div>

      <div class="col-md-2">
        <label class="form-label">Revisão:</label>
        <select name="revisao" class="form-select">
          <option value="">(vazia)</option>
          <option value="0" {% if request.POST.revisao == "0" %}selected{% endif %}>0</option>
          {% for r in REVISOES_VALIDAS %}
            <option value="{{ r }}" {% if request.POST.revisao == r|stringformat:"s" %}selected{% endif %}>{{ r }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-6">
        <label class="form-label">Código <span class="dash-req">*</span><span class="dash-reqhint">Obrigatório</span></label>
        <input type="text" name="codigo" class="form-control" required
               placeholder="Ex: I-CR-4880.00-1200-000-CZ1-001"
               value="{{ request.POST.codigo|default:'' }}">
      </div>

      <div class="col-12">
        <label class="form-label">Título <span class="dash-req">*</span><span class="dash-reqhint">Obrigatório</span></label>
        <input type="text" name="titulo" class="form-control dash-input-lg" required
               placeholder="Ex: COMMISSIONING PLAN"
               value="{{ request.POST.titulo|default:'' }}">
      </div>

      <div class="col-12">
        <label class="form-label">Arquivo(s) <span class="dash-req">*</span><span class="dash-reqhint">Obrigatório</span></label>

        <div class="dash-dropzone" id="dzArquivos" tabindex="0" role="button" aria-label="Área para anexar arquivos">
          <!-- Fallback inline style: esconde o input mesmo sem CSS externo -->
          <input type="file" name="arquivos" id="id_arquivos" required multiple
                 style="position:absolute;inset:0;width:100%;height:100%;opacity:0;cursor:pointer;">

          <div class="dz-title"><i class="bi bi-cloud-arrow-up"></i> Arraste e solte aqui</div>
          <div class="dz-sub">ou clique para selecionar arquivos</div>
          <div class="dz-meta">Dica: você pode selecionar mais de um arquivo (Ctrl/Shift).</div>

          <div class="dash-filechips" id="fileChips"></div>
          <div class="small text-muted mt-2" id="fileEmpty">Nenhum arquivo selecionado.</div>
        </div>

        <div class="form-text">Se sua view aceitar só 1 arquivo, remova o <code>multiple</code>.</div>
      </div>

    </div>

    <div class="dash-actions mt-4">
      <button type="submit" class="dash-btn dash-btn-primary">
        <i class="bi bi-send"></i> Enviar Documento
      </button>
    </div>

  </form>
</div>

<script>
(function(){
  const dz = document.getElementById('dzArquivos');
  const input = document.getElementById('id_arquivos');
  const chips = document.getElementById('fileChips');
  const empty = document.getElementById('fileEmpty');
  if(!dz || !input) return;

  function keyFor(f){ return `${f.name}|${f.size}|${f.lastModified}`; }
  function mergeFiles(existing, added){
    const map = new Map();
    [...existing, ...added].forEach(f => map.set(keyFor(f), f));
    return Array.from(map.values());
  }
  function setFiles(filesArr){
    try{
      const dt = new DataTransfer();
      filesArr.forEach(f => dt.items.add(f));
      input.files = dt.files;
    }catch(e){}
  }

  function render(){
    const files = Array.from(input.files || []);
    chips.innerHTML = '';
    if(!files.length){
      empty.style.display = '';
      return;
    }
    empty.style.display = 'none';

    files.forEach((f, idx) => {
      const chip = document.createElement('span');
      chip.className = 'dash-chip';

      const name = document.createElement('span');
      name.className = 'dash-chip-name';
      name.title = f.name;
      name.textContent = f.name;

      const rm = document.createElement('button');
      rm.type = 'button';
      rm.className = 'dash-chip-remove';
      rm.title = 'Remover';
      rm.setAttribute('aria-label', 'Remover arquivo');
      rm.innerHTML = '&times;';
      rm.addEventListener('click', () => {
        const current = Array.from(input.files || []);
        const next = current.filter((_, i) => i !== idx);
        setFiles(next);
        render();
      });

      chip.appendChild(name);
      chip.appendChild(rm);
      chips.appendChild(chip);
    });
  }

  input.addEventListener('change', render);

  dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('is-dragover'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('is-dragover'));
  dz.addEventListener('drop', (e) => {
    e.preventDefault();
    dz.classList.remove('is-dragover');
    const dropped = Array.from(e.dataTransfer?.files || []);
    if(!dropped.length) return;
    const current = Array.from(input.files || []);
    setFiles(mergeFiles(current, dropped));
    render();
  });

  dz.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); input.click(); }
  });

  render();
})();
</script>

</div>

{% endblock %}
