{% extends "documentos/base.html" %}
{% block title %}üìÅ Lista de Documentos ¬∑ D‚ÄôOR@NGE Enterprise{% endblock %}

{% block extra_head %}
<!-- Datatables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

<!-- ‚úÖ DataTables Responsive (necess√°rio porque voc√™ usa responsive:true) -->
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<style>
/* ====== Responsividade (fontes e espa√ßamento) ====== */
:root{
  --fs-base: clamp(14px, 0.95vw, 16px);
  --gap: clamp(10px, 1.1vw, 16px);
  --radius: 14px;
}

html{ font-size: var(--fs-base); }

/* Header */
.page-header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom: clamp(0.9rem, 1.2vw, 1.4rem);
  gap: var(--gap);
  flex-wrap: wrap;
}

.page-header h2 {
  margin:0;
  font-weight:700;
  font-size: clamp(1.15rem, 1.2vw + .7rem, 1.55rem);
  color: var(--accent-blue);
  display:flex;
  align-items:center;
  gap:.5rem;
}

/* Card filtros */
.filtro-card {
  background: var(--bg-card);
  border:1px solid var(--border);
  border-radius: var(--radius);
  padding: clamp(.9rem, 1.1vw, 1.2rem);
  box-shadow:0 4px 14px var(--shadow);
}

.filtro-card label {
  font-weight:600;
  font-size:.78rem;
  color:var(--text-soft);
  margin-bottom:.25rem;
  display:block;
}

/* Inputs */
.filtro-card .form-select,
.filtro-card .form-control {
  background:#101a2b!important;
  border-radius:10px!important;
  border:1px solid rgba(255,255,255,.10)!important;
  color:#dce8ff!important;
  font-size:.92rem;
  padding:.55rem .75rem;
  width: 100%;
  max-width: 100%;
}

/* ‚úÖ Grid auto-ajust√°vel para filtros (substitui row/col-md) */
.filters-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--gap);
  align-items:end;
}

.filter-item{ min-width: 0; } /* evita overflow em telas menores */

/* campo de busca fica maior quando tiver espa√ßo */
.filter-wide{ grid-column: span 2; }

/* bot√£o buscar */
.filter-actions{
  display:flex;
  align-items:end;
}

.btn-premium { border-radius:10px; font-weight:600; }

/* Mobile: tudo em 1 coluna */
@media (max-width: 740px){
  .filter-wide{ grid-column: auto; }
  .page-header .d-flex{
    width: 100%;
    justify-content: flex-start;
    flex-wrap: wrap;
  }
}

/* Tabela */
#tabelaDocumentos { font-size:.90rem; }
#tabelaDocumentos thead { background:rgba(56,189,248,0.10); color:var(--accent-blue); }

.badge-status { padding:4px 9px; border-radius:8px; font-size:.75rem; }
.badge-doc { background:#0ea5e9; color:white; }
.badge-emissao { background:#fbbf24; color:#111; font-weight:600; }

/* Mant√©m a tabela utiliz√°vel em telas pequenas */
.table-responsive{
  width: 100%;
  overflow-x: auto;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="bi bi-folder2-open"></i> Lista de Documentos</h2>

    <div class="d-flex gap-2">
        <a href="{% url 'documentos:upload_documento' %}" class="btn btn-success btn-premium">
            <i class="bi bi-file-earmark-plus"></i> Novo Documento
        </a>

        {% if request.user.is_superuser %}
        <button form="formExcluir" class="btn btn-outline-danger btn-premium">
            <i class="bi bi-trash"></i> Excluir Selecionados
        </button>
        {% endif %}
    </div>
</div>

<div class="filtro-card mb-3">
  <!-- ‚úÖ Troquei row/col-md por grid responsivo -->
  <form method="GET" class="filters-grid">
      <div class="filter-item">
          <label>Projeto</label>
          <select name="projeto" class="form-select">
              <option value="">Todos</option>
              {% for p in projetos %}
              <option value="{{ p }}" {% if request.GET.projeto == p %}selected{% endif %}>{{ p }}</option>
              {% endfor %}
          </select>
      </div>

      <div class="filter-item">
          <label>Disciplina</label>
          <select name="disciplina" class="form-select">
              <option value="">Todas</option>
              {% for d in disciplinas %}
              <option value="{{ d }}" {% if request.GET.disciplina == d %}selected{% endif %}>{{ d }}</option>
              {% endfor %}
          </select>
      </div>

      <div class="filter-item">
          <label>Status Documento</label>
          <select name="status_documento" class="form-select">
              <option value="">Todos</option>
              {% for s in status_documento_list %}
              <option value="{{ s }}" {% if request.GET.status_documento == s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
          </select>
      </div>

      <div class="filter-item">
          <label>Status Emiss√£o</label>
          <select name="status_emissao" class="form-select">
              <option value="">Todos</option>
              {% for e in status_emissao_list %}
              <option value="{{ e }}" {% if request.GET.status_emissao == e %}selected{% endif %}>{{ e }}</option>
              {% endfor %}
          </select>
      </div>

      <div class="filter-item filter-wide">
          <label>Busca Global</label>
          <input type="text" name="busca" value="{{ request.GET.busca }}" class="form-control" placeholder="C√≥digo, t√≠tulo...">
      </div>

      <div class="filter-item filter-actions">
          <button class="btn btn-primary w-100 btn-premium" type="submit" aria-label="Buscar">
            <i class="bi bi-search"></i>
          </button>
      </div>
  </form>
</div>

<div class="card p-3 shadow-sm">
  <div class="table-responsive">

    {% if request.user.is_superuser %}
    <form id="formExcluir" method="POST" action="{% url 'documentos:excluir_selecionados' %}">
        {% csrf_token %}
    {% endif %}

    <table id="tabelaDocumentos" class="table table-hover table-bordered align-middle">
      <thead>
        <tr>
          {% if request.user.is_superuser %}
              <th><input type="checkbox" id="selectAll"></th>
          {% endif %}
          <th>Projeto</th>
          <th>Fase</th>
          <th>Tipo</th>
          <th>C√≥digo</th>
          <th>Rev</th>
          <th>Disciplina</th>
          <th>T√≠tulo</th>
          <th>Status Documento</th>
          <th>Status Emiss√£o</th>
          <th>GRDT</th>
          <th>PCF</th>
          <th>Data</th>
          <th>Arquivo</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>

      <tbody>
        {% for doc in documentos %}
        <tr>
          {% if request.user.is_superuser %}
          <td><input type="checkbox" class="selectItem" name="selecionados" value="{{ doc.id }}"></td>
          {% endif %}

          <td>{{ doc.projeto.nome|default:"‚Äî" }}</td>
          <td>{{ doc.fase }}</td>
          <td>{{ doc.tipo_doc }}</td>
          <td><b>{{ doc.codigo }}</b></td>
          <td>{{ doc.revisao }}</td>
          <td>{{ doc.disciplina }}</td>
          <td>{{ doc.titulo }}</td>

          <td>
            {% if doc.status_documento %}
              <span class="badge badge-status badge-doc">{{ doc.status_documento }}</span>
            {% else %}‚Äî{% endif %}
          </td>

          <td>
            {% if doc.status_emissao %}
              <span class="badge badge-status badge-emissao">{{ doc.status_emissao }}</span>
            {% else %}‚Äî{% endif %}
          </td>

          <td>{{ doc.grdt_cliente|default:"‚Äî" }}</td>
          <td>{{ doc.resposta_cliente|default:"‚Äî" }}</td>
          <td>{% if doc.data_emissao_grdt %}{{ doc.data_emissao_grdt|date:"d/m/Y" }}{% else %}‚Äî{% endif %}</td>

          <td>
            {% if doc.arquivos.all|length > 0 %}
              <a href="{% url 'documentos:detalhes_documento' doc.id %}" class="btn btn-sm btn-primary btn-premium">Abrir</a>
            {% else %}
              <span class="text-muted">Sem</span>
            {% endif %}
          </td>

          <td>
            <a href="{% url 'documentos:detalhes_documento' doc.id %}" class="btn btn-sm btn-outline-secondary btn-premium">Detalhes</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if request.user.is_superuser %}
    </form>
    {% endif %}

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- ‚úÖ DataTables Responsive (JS) -->
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<script>
$(document).ready(function(){
    $('#tabelaDocumentos').DataTable({
        pageLength: 25,
        lengthMenu: [10,25,50,100],
        responsive: true,
        scrollX: true,
        dom:'Bfrtip',
        buttons:[
            { extend:'excelHtml5', text:'Excel' },
            { extend:'csvHtml5', text:'CSV' },
            { extend:'print', text:'Imprimir' }
        ],
        language:{ url:"https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json" }
    });

    document.getElementById("selectAll")?.addEventListener("change", e=>{
        document.querySelectorAll(".selectItem").forEach(c=>c.checked = e.target.checked);
    });
});
</script>
{% endblock %}
