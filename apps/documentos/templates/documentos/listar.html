{% extends "documentos/base.html" %}

{% block title %}Lista de Documentos{% endblock %}

{% block content %}

<h2 class="text-primary fw-bold mb-3">ðŸ“„ Lista de Documentos</h2>

<!-- FILTROS -->
<form method="GET" class="card p-3 mb-4 shadow-sm">
    <div class="row g-3">

        <div class="col-md-2">
            <label class="form-label">Projeto</label>
            <select name="projeto" class="form-select">
                <option value="">Todos</option>
                {% for p in projetos %}
                    <option value="{{ p }}" {% if request.GET.projeto == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label">Disciplina</label>
            <select name="disciplina" class="form-select">
                <option value="">Todas</option>
                {% for d in disciplinas %}
                    <option value="{{ d }}" {% if request.GET.disciplina == d %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label">Status LDP</label>
            <select name="status_ldp" class="form-select">
                <option value="">Todos</option>
                {% for s in status_ldp_list %}
                    <option value="{{ s }}" {% if request.GET.status_ldp == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label">Status EmissÃ£o</label>
            <select name="status_emissao" class="form-select">
                <option value="">Todos</option>
                {% for e in status_emissao_list %}
                    <option value="{{ e }}" {% if request.GET.status_emissao == e %}selected{% endif %}>{{ e }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">Busca (CÃ³digo ou TÃ­tulo)</label>
            <input type="text" name="busca" class="form-control"
                   value="{{ request.GET.busca }}" placeholder="Ex: 4880 ou RelatÃ³rio">
        </div>

        <div class="col-md-1 d-flex align-items-end">
            <button class="btn btn-primary w-100">Filtrar</button>
        </div>

    </div>
</form>

<!-- BOTÃƒO NOVO DOCUMENTO -->
<a href="{% url 'documentos:upload_documento' %}" class="btn btn-success mb-3 shadow-sm">
    âž• Novo Documento
</a>

<!-- EXCLUIR SELECIONADOS (APENAS SUPERUSER) -->
{% if request.user.is_superuser %}
<form method="POST" action="{% url 'documentos:excluir_selecionados' %}" id="formExcluir">
    {% csrf_token %}
{% endif %}

<!-- TABELA -->
<div class="table-responsive card shadow-sm p-3">
    <table class="table table-striped table-bordered align-middle" id="tabelaDocumentos">
        <thead class="table-primary">
            <tr>

                {% if request.user.is_superuser %}
                <th style="width: 40px;" class="text-center">
                    <input type="checkbox" id="selectAll">
                </th>
                {% endif %}

                <th>Projeto</th>
                <th>Fase</th>
                <th>Tipo Doc</th>
                <th>CÃ³digo</th>
                <th>RevisÃ£o</th>
                <th>Disciplina</th>
                <th>TÃ­tulo</th>
                <th>Status LDP</th>
                <th>Status EmissÃ£o</th>
                <th>GRDT</th>
                <th>PCF</th>
                <th>EmissÃ£o</th>
                <th>Arquivo</th>
                <th>AÃ§Ãµes</th>
            </tr>
        </thead>

        <tbody>
            {% for doc in documentos %}
            <tr>

                {% if request.user.is_superuser %}
                <td class="text-center">
                    <input type="checkbox" name="ids" value="{{ doc.id }}" class="selectItem">
                </td>
                {% endif %}

                <td>{{ doc.projeto }}</td>
                <td>{{ doc.fase }}</td>
                <td>{{ doc.tipo_doc }}</td>
                <td><strong>{{ doc.codigo }}</strong></td>
                <td>{{ doc.revisao }}</td>
                <td>{{ doc.disciplina }}</td>
                <td>{{ doc.titulo }}</td>

                <!-- STATUS LDP -->
                <td>
                    <span class="badge bg-info text-dark">{{ doc.status_ldp }}</span>
                </td>

                <!-- STATUS EMISSÃƒO -->
                <td>
                    <span class="badge bg-warning text-dark">{{ doc.status_emissao }}</span>
                </td>

                <td>{{ doc.numero_grdt }}</td>
                <td>{{ doc.numero_pcf }}</td>

                <td>
                    {% if doc.data_emissao_tp %}
                        {{ doc.data_emissao_tp|date:"d/m/Y" }}
                    {% else %}
                        â€”
                    {% endif %}
                </td>

                <td>
                    {% if doc.arquivo %}
                        <a href="{{ doc.arquivo.url }}" class="btn btn-outline-primary btn-sm" download>Baixar</a>
                    {% else %}
                        <span class="text-muted">Sem arquivo</span>
                    {% endif %}
                </td>

                <td class="text-center">
                    <a href="{% url 'documentos:detalhes_documento' doc.id %}"
                       class="btn btn-info btn-sm text-white">Detalhes</a>
                </td>

            </tr>
            {% endfor %}
        </tbody>

    </table>
</div>

{% if request.user.is_superuser %}
<button type="submit" class="btn btn-danger mt-3">
    <i class="bi bi-trash"></i> Excluir Selecionados
</button>
</form>
{% endif %}

<!-- DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- BotÃµes de exportaÃ§Ã£o -->
<link rel="stylesheet"
      href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<!-- INICIALIZAÃ‡ÃƒO DATATABLE -->
<script>
$(document).ready(function () {
    $('#tabelaDocumentos').DataTable({
        pageLength: 20,
        lengthMenu: [10, 20, 50, 100, 500],
        ordering: true,
        searching: true,
        language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json" },
        dom: 'Bfrtip',
        buttons: [
            { extend: 'excelHtml5', text: 'Exportar Excel', className: 'btn btn-success' },
            { extend: 'pdfHtml5', text: 'Exportar PDF', className: 'btn btn-danger' },
            { extend: 'print', text: 'Imprimir', className: 'btn btn-secondary' }
        ]
    });

    // Selecionar / deselecionar todos
    $("#selectAll").on("click", function () {
        $(".selectItem").prop("checked", this.checked);
    });
});
</script>

{% endblock %}
