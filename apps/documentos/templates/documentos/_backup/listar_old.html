{% extends "documentos/base.html" %}

{% block title %}üìÅ Lista de Documentos ¬∑ GED D'OR@NGE{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

<style>
.page-header{
    display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;
}
.page-header h2{font-weight:700;font-size:1.45rem;margin:0;color:var(--accent-blue);}
.btn-primary,.btn-success{border-radius:10px;}
.filtro-card{
    border-radius:14px;padding:1rem;background:var(--bg-card);
    border:1px solid var(--border);box-shadow:0 3px 10px var(--shadow);
}
#tabelaDocumentos{font-size:.88rem;}
#tabelaDocumentos thead{background:var(--accent-gold-soft);color:var(--accent-blue);font-weight:600;}
.dataTables_wrapper .dt-buttons button{border-radius:10px!important;}
.badge-status{padding:3px 8px;border-radius:8px;font-size:.75rem;}
.badge-doc{background:#0ea5e9;color:white;}
.badge-emissao{background:#fbbf24;color:#111827;font-weight:600;}
</style>
{% endblock %}


{% block content %}

<!-- üî∑ CABE√áALHO -->
<div class="page-header">
    <h2><i class="bi bi-folder2-open"></i> Lista de Documentos</h2>

    <div class="d-flex gap-2">
        <a href="{% url 'documentos:upload_documento' %}" class="btn btn-success">
            <i class="bi bi-file-earmark-plus"></i> Novo Documento
        </a>

        {% if request.user.is_superuser %}
        <form method="POST" action="{% url 'documentos:excluir_selecionados' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger">
                <i class="bi bi-trash"></i> Excluir Selecionados
            </button>
        </form>
        {% endif %}
    </div>
</div>


<!-- üß© FILTROS AVAN√áADOS -->
<div class="filtro-card mb-3">
<form method="GET" class="row g-3">

<div class="col-md-2">
<label class="form-label">Projeto</label>
<select name="projeto" class="form-select">
<option value="">Todos</option>
{% for p in projetos %}<option value="{{ p }}" {% if request.GET.projeto == p %}selected{% endif %}>{{ p }}</option>{% endfor %}
</select>
</div>

<div class="col-md-2">
<label class="form-label">Disciplina</label>
<select name="disciplina" class="form-select">
<option value="">Todas</option>
{% for d in disciplinas %}<option value="{{ d }}" {% if request.GET.disciplina == d %}selected{% endif %}>{{ d }}</option>{% endfor %}
</select>
</div>

<div class="col-md-2">
<label class="form-label">Status do Documento</label>
<select name="status_ldp" class="form-select">
<option value="">Todos</option>
{% for s in status_ldp_list %}<option value="{{ s }}" {% if request.GET.status_ldp == s %}selected{% endif %}>{{ s }}</option>{% endfor %}
</select>
</div>

<div class="col-md-2">
<label class="form-label">Status Emiss√£o</label>
<select name="status_emissao" class="form-select">
<option value="">Todos</option>
{% for e in status_emissao_list %}<option value="{{ e }}" {% if request.GET.status_emissao == e %}selected{% endif %}>{{ e }}</option>{% endfor %}
</select>
</div>

<div class="col-md-3">
<label class="form-label">Busca Global</label>
<input type="text" name="busca" class="form-control" placeholder="C√≥digo, t√≠tulo, texto..." value="{{ request.GET.busca }}">
</div>

<div class="col-md-1 d-flex align-items-end"><button class="btn btn-primary w-100">Filtrar</button></div>
</form>
</div>


<!-- üóÇ TABELA -->
<div class="card p-3 shadow-sm"><div class="table-responsive">
<table id="tabelaDocumentos" class="table table-hover table-bordered">
<thead>
<tr>
{% if request.user.is_superuser %}<th><input type="checkbox" id="selectAll"></th>{% endif %}
<th>Projeto</th><th>Fase</th><th>Tipo</th><th>C√≥digo</th><th>Rev</th><th>Disciplina</th>
<th>T√≠tulo</th><th>Status Documento</th><th>Status Emiss√£o</th>
<th>GRDT</th><th>PCF</th><th>Data</th><th>Arquivo</th><th>A√ß√µes</th>
</tr>
</thead>

<tbody>
{% for doc in documentos %}
<tr>
{% if request.user.is_superuser %}<td><input type="checkbox" class="selectItem" name="ids" value="{{ doc.id }}"></td>{% endif %}
<td>{{ doc.projeto }}</td><td>{{ doc.fase }}</td><td>{{ doc.tipo_doc }}</td>
<td><b>{{ doc.codigo }}</b></td><td>{{ doc.revisao }}</td><td>{{ doc.disciplina }}</td>
<td>{{ doc.titulo }}</td>

<td>{% if doc.status_ldp %}<span class="badge badge-status badge-doc">{{ doc.status_ldp }}</span>{% else %}‚Äî{% endif %}</td>
<td>{% if doc.status_emissao %}<span class="badge badge-status badge-emissao">{{ doc.status_emissao }}</span>{% else %}‚Äî{% endif %}</td>

<td>{{ doc.numero_grdt|default:"‚Äî" }}</td>
<td>{{ doc.numero_pcf|default:"‚Äî" }}</td>
<td>{% if doc.data_emissao_tp %}{{ doc.data_emissao_tp|date:"d/m/Y" }}{% else %}‚Äî{% endif %}</td>

<td>{% if doc.arquivos.all|length > 0 %}
<a href="{% url 'documentos:detalhes_documento' doc.id %}" class="btn btn-sm btn-primary">Abrir</a>
{% else %}<span class="text-muted">Sem</span>{% endif %}</td>

<td><a href="{% url 'documentos:detalhes_documento' doc.id %}" class="btn btn-sm btn-outline-secondary">Detalhes</a></td>
</tr>
{% endfor %}
</tbody>
</table></div></div>

{% endblock %}


{% block extra_js %}
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
$(document).ready(function(){
$('#tabelaDocumentos').DataTable({
    pageLength:25,lengthMenu:[10,25,50,100],
    responsive:true,scrollX:true,
    dom:'Bfrtip',
    buttons:[
        {extend:'excelHtml5',text:'Excel'},
        {extend:'csvHtml5',text:'CSV'},
        {extend:'print',text:'Imprimir'},
    ],
    language:{url:"https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json"}
});

document.getElementById("selectAll")?.addEventListener("change",e=>{
    document.querySelectorAll(".selectItem").forEach(c=>c.checked=e.target.checked)
});
});
</script>
{% endblock %}
