{% extends "documentos/base.html" %}
{% load static %}

{% block title %}Dashboard Enterprise – GED{% endblock %}

{% block content %}

<style>
/* ===============================
   DASHBOARD ENTERPRISE – ESTILO
   =============================== */

.section-title {
    font-weight: 700;
    letter-spacing: 0.03em;
    text-shadow: 0 0 10px rgba(0, 234, 255, 0.8);
}

.panel {
    background: rgba(0, 18, 40, 0.85);
    border-radius: 16px;
    border: 1px solid rgba(0, 200, 255, 0.35);
    box-shadow: 0 0 18px rgba(0, 200, 255, 0.25);
    padding: 18px 20px;
}

/* Filtros */
.filter-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    opacity: 0.8;
}

.filter-select,
.filter-input {
    background: rgba(0, 0, 0, 0.5);
    border-radius: 10px;
    border: 1px solid rgba(0, 200, 255, 0.4);
    color: #e8faff;
    font-size: 13px;
}

/* KPIs */
.kpi-card {
    background: radial-gradient(circle at top left, rgba(0,255,255,0.18), rgba(0,0,40,0.9));
    border-radius: 16px;
    border: 1px solid rgba(0,200,255,0.45);
    box-shadow: 0 0 18px rgba(0,200,255,0.35);
    transition: 0.25s ease;
}

.kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 26px rgba(0,255,255,0.6);
}

.kpi-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    opacity: 0.85;
}

.kpi-value {
    font-size: 26px;
}

/* Finanças */
.kpi-card-finance {
    background: radial-gradient(circle at top left, rgba(0,255,190,0.16), rgba(0,10,30,0.96));
    border-radius: 16px;
    border: 1px solid rgba(0,255,190,0.6);
    box-shadow: 0 0 18px rgba(0,255,190,0.35);
}

.kpi-card-finance-warning {
    background: radial-gradient(circle at top left, rgba(255,210,0,0.18), rgba(25,15,0,0.96));
    border-radius: 16px;
    border: 1px solid rgba(255,210,0,0.7);
    box-shadow: 0 0 18px rgba(255,210,0,0.4);
}

.kpi-card-finance-total {
    background: radial-gradient(circle at top left, rgba(0,190,255,0.2), rgba(0,5,40,0.96));
    border-radius: 16px;
    border: 1px solid rgba(0,190,255,0.7);
    box-shadow: 0 0 20px rgba(0,190,255,0.45);
}

.text-soft {
    opacity: 0.75;
    font-size: 13px;
}

/* Tabela Medição Resumida */
.table-med {
    font-size: 12px;
}

.table-med thead th {
    background: linear-gradient(90deg, rgba(0,200,255,0.25), rgba(0,80,140,0.35));
    color: #061018;
    border: none;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.04em;
}

.table-med tbody tr {
    background: rgba(255,255,255,0.03);
    transition: 0.2s ease;
}

.table-med tbody tr:hover {
    background: rgba(0,200,255,0.20);
}

.table-med td {
    border-color: rgba(0,200,255,0.3) !important;
}

/* Gráficos */
.card-chart {
    border-radius: 16px;
    background: rgba(0, 10, 30, 0.95);
    border: 1px solid rgba(0, 200, 255, 0.35);
    box-shadow: 0 0 18px rgba(0, 200, 255, 0.25);
}
</style>


<h2 class="mb-4 text-info fw-bold section-title">
    <i class="bi bi-speedometer2"></i> Dashboard Enterprise – GED
</h2>

<!-- =============================== -->
<!-- FILTROS AVANÇADOS              -->
<!-- =============================== -->
<div class="panel mb-4">
    <form method="get" class="row g-3 align-items-end">

        <div class="col-md-2">
            <label class="filter-label">Projeto</label>
            <select name="projeto" class="form-select filter-select">
                <option value="">Todos</option>
                {% for p in lista_projetos %}
                <option value="{{ p }}" {% if filtros.projeto == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="filter-label">Disciplina</label>
            <select name="disciplina" class="form-select filter-select">
                <option value="">Todas</option>
                {% for d in lista_disciplinas %}
                <option value="{{ d }}" {% if filtros.disciplina == d %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="filter-label">Tipo Doc</label>
            <select name="tipo_doc" class="form-select filter-select">
                <option value="">Todos</option>
                {% for t in lista_tipos %}
                <option value="{{ t }}" {% if filtros.tipo_doc == t %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="filter-label">Status LDP</label>
            <select name="status_ldp" class="form-select filter-select">
                <option value="">Todos</option>
                {% for s in lista_status_ldp %}
                <option value="{{ s }}" {% if filtros.status_ldp == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="filter-label">Status Emissão</label>
            <select name="status_emissao" class="form-select filter-select">
                <option value="">Todos</option>
                {% for se in lista_status_emissao %}
                <option value="{{ se }}" {% if filtros.status_emissao == se %}selected{% endif %}>{{ se }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="filter-label">Data Emissão (início)</label>
            <input type="date" name="dt_ini" value="{{ filtros.dt_ini }}" class="form-control filter-input">
        </div>

        <div class="col-md-2">
            <label class="filter-label">Data Emissão (fim)</label>
            <input type="date" name="dt_fim" value="{{ filtros.dt_fim }}" class="form-control filter-input">
        </div>

        <div class="col-md-2">
            <button type="submit" class="btn btn-sm btn-info w-100 mt-2">
                <i class="bi bi-funnel"></i> Aplicar Filtros
            </button>
        </div>

        <div class="col-md-2">
            <a href="?" class="btn btn-sm btn-outline-light w-100 mt-2">
                <i class="bi bi-x-circle"></i> Limpar
            </a>
        </div>

    </form>
</div>

<!-- =============================== -->
<!-- KPIs OPERACIONAIS & FINANCEIROS -->
<!-- =============================== -->
<div class="row g-3 mb-4">

    <div class="col-md-3">
        <div class="card text-bg-dark kpi-card">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="kpi-label text-info">Doc. Filtrados</div>
                    <div class="kpi-value text-info">{{ total_docs }}</div>
                </div>
                <i class="bi bi-files fs-3 text-info"></i>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card text-bg-dark kpi-card">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="kpi-label text-success">Aprovados</div>
                    <div class="kpi-value text-success">{{ total_aprovados }}</div>
                </div>
                <i class="bi bi-patch-check fs-3 text-success"></i>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card text-bg-dark kpi-card">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="kpi-label text-warning">Em Revisão</div>
                    <div class="kpi-value text-warning">{{ total_em_revisao }}</div>
                </div>
                <i class="bi bi-clock-history fs-3 text-warning"></i>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card text-bg-dark kpi-card">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="kpi-label text-primary">Emitidos</div>
                    <div class="kpi-value text-primary">{{ total_emitidos }}</div>
                </div>
                <i class="bi bi-send-check fs-3 text-primary"></i>
            </div>
        </div>
    </div>

</div>

<div class="row g-3 mb-4">

    <div class="col-md-4">
        <div class="card text-bg-dark kpi-card-finance">
            <div class="card-body">
                <div class="kpi-label text-info">Valor Medido – Emitidos</div>
                <h4 class="mt-2 mb-1 text-success fw-bold">US$ {{ valor_emitidos_usd }}</h4>
                <h5 class="text-success fw-semibold">R$ {{ valor_emitidos_brl }}</h5>
                <div class="text-soft mt-2">Baseado somente nos documentos efetivamente emitidos.</div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-bg-dark kpi-card-finance-warning">
            <div class="card-body">
                <div class="kpi-label text-warning">Valor a Medir – Não Recebidos</div>
                <h4 class="mt-2 mb-1 text-warning fw-bold">US$ {{ valor_nao_rec_usd }}</h4>
                <h5 class="text-warning fw-semibold">R$ {{ valor_nao_rec_brl }}</h5>
                <div class="text-soft mt-2">
                    Potencial financeiro ainda não retornado pelo cliente (status "Não Recebido").
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-bg-dark kpi-card-finance-total">
            <div class="card-body">
                <div class="kpi-label text-primary">Valor Total do Projeto (Filtrado)</div>
                <h4 class="mt-2 mb-1 text-info fw-bold">US$ {{ valor_total_usd }}</h4>
                <h5 class="text-info fw-semibold">R$ {{ valor_total_brl }}</h5>
                <div class="text-soft mt-2">
                    Soma de Emitidos + Não Recebidos dentro do contexto filtrado.
                </div>
            </div>
        </div>
    </div>

</div>

<!-- =============================== -->
<!-- GRÁFICOS                        -->
<!-- =============================== -->
<div class="row g-4 mb-4">

    <div class="col-md-6">
        <div class="card text-bg-dark card-chart">
            <div class="card-header border-0 bg-transparent">
                <i class="bi bi-diagram-3"></i> Documentos por Disciplina
            </div>
            <div class="card-body">
                <canvas id="chartDisciplinas"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card text-bg-dark card-chart">
            <div class="card-header border-0 bg-transparent">
                <i class="bi bi-bar-chart"></i> Status LDP (Distribuição)
            </div>
            <div class="card-body">
                <canvas id="chartStatus"></canvas>
            </div>
        </div>
    </div>

</div>

<!-- =============================== -->
<!-- TABELA DE MEDIÇÃO RESUMIDA      -->
<!-- =============================== -->
<h4 class="mt-4 mb-3 text-info fw-bold section-title">
    <i class="bi bi-ui-checks-grid"></i> Medição Financeira Resumida (por Tipo)
</h4>

<div class="panel mb-5">
    <div class="table-responsive">
        <table class="table table-dark table-bordered table-sm align-middle text-center table-med">
            <thead class="table-info text-dark fw-bold">
                <tr>
                    <th>Tipo Doc</th>
                    <th>Total</th>
                    <th>Emitidos</th>
                    <th>Não Recebidos</th>
                    <th>Valor Emitidos (USD)</th>
                    <th>Valor Emitidos (BRL)</th>
                    <th>Valor Não Recebidos (USD)</th>
                    <th>Valor Não Recebidos (BRL)</th>
                </tr>
            </thead>
            <tbody>
                {% for linha in medicao_linhas %}
                <tr>
                    <td class="text-info fw-bold">{{ linha.tipo_doc }}</td>
                    <td>{{ linha.total }}</td>
                    <td class="text-primary fw-bold">{{ linha.emitidos }}</td>
                    <td class="text-danger fw-bold">{{ linha.nao_recebidos }}</td>
                    <td class="text-success fw-bold">US$ {{ linha.valor_emitidos_usd }}</td>
                    <td class="text-success fw-bold">R$ {{ linha.valor_emitidos_brl }}</td>
                    <td class="text-warning fw-bold">US$ {{ linha.valor_nr_usd }}</td>
                    <td class="text-warning fw-bold">R$ {{ linha.valor_nr_brl }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr style="background: rgba(0,255,200,0.12); font-weight: bold;">
                    <td>Total Geral</td>
                    <td>{{ medicao_totais.total_docs }}</td>
                    <td colspan="3"></td>
                    <td colspan="2" class="text-success">US$ {{ medicao_totais.total_usd }}</td>
                    <td class="text-warning">R$ {{ medicao_totais.total_brl }}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const discLabels = {{ disc_labels|safe }};
const discData   = {{ disc_data|safe }};
const statusLabels = {{ status_labels|safe }};
const statusData   = {{ status_data|safe }};

/* Gráfico de disciplinas */
new Chart(document.getElementById('chartDisciplinas'), {
    type: 'bar',
    data: {
        labels: discLabels,
        datasets: [{
            data: discData,
            backgroundColor: 'rgba(0, 200, 255, 0.55)',
            borderColor: 'rgba(0, 200, 255, 1)',
            borderWidth: 1,
        }]
    },
    options: {
        plugins: { 
            legend: { display: false }
        },
        scales: {
            x: { ticks: { color: '#fff' }},
            y: { ticks: { color: '#fff' }}
        }
    }
});

/* Gráfico de Status */
new Chart(document.getElementById('chartStatus'), {
    type: 'doughnut',
    data: {
        labels: statusLabels,
        datasets: [{
            data: statusData,
            backgroundColor: [
                '#00eaff', '#00ffaa', '#ffaa00',
                '#ff77aa', '#33ccff', '#00ffcc'
            ],
            borderWidth: 1
        }]
    },
    options: {
        plugins: {
            legend: { labels: { color: '#fff' }}
        }
    }
});
</script>

{% endblock %}
