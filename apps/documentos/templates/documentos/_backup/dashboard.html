{% extends "documentos/base.html" %}
{% load static %}

{% block title %}Dashboard GED{% endblock %}

{% block content %}

<style>
/* =========================================
   ESTILO FUTURISTA NEON FULL GLOW ‚Äì DASHBOARD
   ========================================= */

.section-title {
    font-weight: 700;
    letter-spacing: 0.03em;
    text-shadow: 0 0 10px rgba(0, 234, 255, 0.8);
}

.kpi-card {
    background: radial-gradient(circle at top left, rgba(0,255,255,0.18), rgba(0,0,40,0.9));
    border-radius: 16px;
    border: 1px solid rgba(0,200,255,0.45);
    box-shadow: 0 0 18px rgba(0,200,255,0.35);
    transition: 0.25s ease;
}

.kpi-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 0 26px rgba(0,255,255,0.55);
}

.kpi-label {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    opacity: 0.85;
}

.kpi-value {
    font-size: 26px;
}

/* Finan√ßas */
.kpi-card-finance {
    border-radius: 16px;
    background: radial-gradient(circle at top left, rgba(0,255,190,0.16), rgba(0,10,30,0.96));
    box-shadow: 0 0 20px rgba(0,255,190,0.35);
    border: 1px solid rgba(0,255,190,0.5);
}

.kpi-card-finance-warning {
    background: radial-gradient(circle at top left, rgba(255,210,0,0.18), rgba(25,15,0,0.96));
    box-shadow: 0 0 20px rgba(255,210,0,0.35);
    border: 1px solid rgba(255,210,0,0.55);
}

.kpi-card-finance-total {
    background: radial-gradient(circle at top left, rgba(0,190,255,0.2), rgba(0,5,40,0.96));
    box-shadow: 0 0 22px rgba(0,190,255,0.45);
    border: 1px solid rgba(0,190,255,0.6);
}

.text-soft {
    opacity: 0.75;
    font-size: 13px;
}

/* Tabela de Medi√ß√£o dentro do Dashboard */
.table-medicao {
    font-size: 13px;
}

.table-medicao thead th {
    background: linear-gradient(90deg, rgba(0,200,255,0.25), rgba(0,80,140,0.35));
    color: #061018;
    border: none;
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 0.04em;
}

.table-medicao tbody tr {
    background: rgba(255,255,255,0.03);
    transition: 0.25s ease;
}

.table-medicao tbody tr:hover {
    background: rgba(0,200,255,0.20);
}

.table-medicao td {
    border-color: rgba(0,200,255,0.3) !important;
}

/* Auditoria */
.audit-table thead th {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.audit-table td {
    font-size: 13px;
}

/* Gr√°ficos */
.card-chart {
    border-radius: 16px;
    background: rgba(0, 15, 35, 0.85);
    border: 1px solid rgba(0,200,255,0.35);
    box-shadow: 0 0 18px rgba(0,200,255,0.25);
}

/* Pequenos ajustes */
.badge-soft {
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 11px;
    text-transform: uppercase;
}

/* Fim estilo */
</style>

<h2 class="mb-4 text-info fw-bold section-title">
    <i class="bi bi-speedometer2"></i> Dashboard GED ‚Äì Vis√£o Geral
</h2>

<!-- KPIs PRINCIPAIS --------------------------------------------------------- -->
<div class="row g-3 mb-4">

    <div class="col-md-3">
        <div class="card text-bg-dark shadow-sm kpi-card">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="kpi-label text-info">Total Documentos Ativos</div>
                    <div class="kpi-value text-info">{{ total_docs }}</div>
                </div>
                <i class="bi bi-files fs-3 text-info"></i>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card text-bg-dark shadow-sm kpi-card">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="kpi-label text-success">Aprovados</div>
                    <div class="kpi-value text-success">{{ total_aprovados }}</div>
                </div>
                <i class="bi bi-patch-check fs-3 text-success"></i>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card text-bg-dark shadow-sm kpi-card">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="kpi-label text-warning">Em Revis√£o</div>
                    <div class="kpi-value text-warning">{{ total_em_revisao }}</div>
                </div>
                <i class="bi bi-clock-history fs-3 text-warning"></i>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card text-bg-dark shadow-sm kpi-card">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="kpi-label text-primary">Emitidos</div>
                    <div class="kpi-value text-primary">{{ total_emitidos }}</div>
                </div>
                <i class="bi bi-send-check fs-3 text-primary"></i>
            </div>
        </div>
    </div>

</div>

<!-- ====================================================== -->
<!-- üî• NOVOS CARDS FINANCEIROS ‚Äì NEON FULL GLOW üî• -->
<!-- ====================================================== -->
<h3 class="mt-3 mb-3 text-info fw-bold section-title">
    <i class="bi bi-currency-exchange"></i> Medi√ß√£o ‚Äì KPIs Financeiros
</h3>

<div class="row g-3 mb-4">

    <!-- Valor Medido Emitidos -->
    <div class="col-md-4">
        <div class="card text-bg-dark shadow-sm kpi-card-finance">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold text-info" style="font-size: 14px;">
                        Valor Medido ‚Äì Emitidos
                    </span>
                    <span class="badge-soft bg-dark text-success border border-success">
                        <i class="bi bi-check2-circle"></i> Confirmado
                    </span>
                </div>

                <h4 class="mt-2 mb-1 text-success fw-bold">
                    US$ {{ valor_emitidos_usd }}
                </h4>
                <h5 class="text-success fw-semibold">
                    R$ {{ valor_emitidos_brl }}
                </h5>

                <div class="text-soft mt-2">
                    Baseado apenas nos documentos efetivamente <strong>emitidos</strong>.
                </div>
            </div>
        </div>
    </div>

    <!-- Valor N√£o Recebidos -->
    <div class="col-md-4">
        <div class="card text-bg-dark shadow-sm kpi-card-finance-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold text-warning" style="font-size: 14px;">
                        Valor a Medir ‚Äì N√£o Recebidos
                    </span>
                    <span class="badge-soft bg-dark text-warning border border-warning">
                        <i class="bi bi-hourglass-split"></i> Pendente
                    </span>
                </div>

                <h4 class="mt-2 mb-1 text-warning fw-bold">
                    US$ {{ valor_nao_rec_usd }}
                </h4>
                <h5 class="text-warning fw-semibold">
                    R$ {{ valor_nao_rec_brl }}
                </h5>

                <div class="text-soft mt-2">
                    Representa o potencial financeiro ainda <strong>n√£o recebido / pendente</strong>.
                </div>
            </div>
        </div>
    </div>

    <!-- Total Financeiro -->
    <div class="col-md-4">
        <div class="card text-bg-dark shadow-sm kpi-card-finance-total">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold text-primary" style="font-size: 14px;">
                        Valor Total do Projeto (USD / BRL)
                    </span>
                    <span class="badge-soft bg-dark text-info border border-info">
                        <i class="bi bi-graph-up-arrow"></i> Proje√ß√£o
                    </span>
                </div>

                <h4 class="mt-2 mb-1 text-info fw-bold">
                    US$ {{ valor_total_usd }}
                </h4>
                <h5 class="text-info fw-semibold">
                    R$ {{ valor_total_brl }}
                </h5>

                <div class="text-soft mt-2">
                    Soma de <strong>Emitidos</strong> + <strong>N√£o Recebidos</strong>.
                </div>
            </div>
        </div>
    </div>

</div>

<!-- KPIs LIXEIRA / AUDITORIA ------------------------------------------------ -->
<div class="row g-3 mb-4">

    <div class="col-md-4">
        <div class="card text-bg-dark shadow-sm kpi-card">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="kpi-label text-danger">Documentos na Lixeira</div>
                    <div class="kpi-value text-danger">{{ total_excluidos }}</div>
                </div>
                <i class="bi bi-trash3-fill fs-3 text-danger"></i>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-bg-dark shadow-sm kpi-card">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="kpi-label text-info">Documentos Restaurados</div>
                    <div class="kpi-value text-info">{{ total_restaurados }}</div>
                </div>
                <i class="bi bi-arrow-counterclockwise fs-3 text-info"></i>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-bg-dark shadow-sm kpi-card">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="kpi-label text-light">Eventos em Auditoria (√∫ltimos 20)</div>
                    <div class="kpi-value text-light">
                        {% if auditoria_acoes %}{{ auditoria_acoes|length }}{% else %}0{% endif %}
                    </div>
                </div>
                <i class="bi bi-activity fs-3 text-light"></i>
            </div>
        </div>
    </div>

</div>

<!-- =============================================== -->
<!-- üî• SE√á√ÉO MEDI√á√ÉO ‚Äì ESTILO PLANILHA FUTURISTA üî• -->
<!-- =============================================== -->
<h3 class="mt-5 mb-3 text-info fw-bold section-title">
    <i class="bi bi-calculator"></i> Medi√ß√£o (por Tipo de Documento)
</h3>

<div class="card text-bg-dark shadow-lg mb-4"
     style="border: 1px solid rgba(0,200,255,0.35); box-shadow: 0 0 12px #009dff; border-radius: 16px;">
    <div class="card-body table-responsive">

        <table class="table table-sm table-dark text-center">
            <thead>
                <tr>
                    <th>Tipo Doc</th>
                    <th>Total</th>
                    <th>Emitidos</th>
                    <th>N√£o Recebidos</th>
                    <th>Valor Emitidos (USD)</th>
                    <th>Valor N√£o Recebidos (USD)</th>
                    <th>Valor Total (USD)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Total Geral</td>
                    <td>{{ total_docs }}</td>
                    <td>{{ total_emitidos }}</td>
                    <td>{{ total_nao_recebidos }}</td>
                    <td>{{ valor_emitidos_usd }}</td>
                    <td>{{ valor_nao_rec_usd }}</td>
                    <td>{{ valor_total_usd }}</td>
                </tr>
            </tbody>
        </table>
        

            <tbody>
                {% for m in medicao_linhas %}
                <tr>
                    <td class="text-info fw-bold">{{ m.tipo_doc }}</td>
                    <td>{{ m.total }}</td>
                    <td class="text-primary fw-bold">{{ m.emitidos }}</td>
                    <td class="text-warning fw-bold">{{ m.revisar }}</td>
                    <td class="text-muted">{{ m.nao_recebidos }}</td>
                    <td>{{ m.emitir }}</td>
                    <td class="text-success fw-bold">$ {{ m.valor_usd }}</td>
                    <td class="text-warning fw-bold">R$ {{ m.valor_brl }}</td>
                </tr>
                {% endfor %}
            </tbody>

            <tfoot>
                <tr style="background: rgba(0,255,200,0.08); font-weight: bold;">
                    <td>Total Geral</td>
                    <td>{{ medicao_totais.total_docs }}</td>
                    <td>{{ medicao_totais.total_emitidos }}</td>
                    <td>{{ medicao_totais.total_revisar }}</td>
                    <td>{{ medicao_totais.total_nao_recebidos }}</td>
                    <td>{{ medicao_totais.total_emitir }}</td>
                    <td class="text-success">$ {{ medicao_totais.total_usd }}</td>
                    <td class="text-warning">R$ {{ medicao_totais.total_brl }}</td>
                </tr>
            </tfoot>

        </table>
    </div>
</div>

<!-- GR√ÅFICOS --------------------------------------------------------------- -->
<div class="row g-4 mb-4">

    <div class="col-md-6">
        <div class="card text-bg-dark shadow-sm card-chart">
            <div class="card-header border-0 bg-transparent">
                <i class="bi bi-diagram-3"></i> Documentos por Disciplina
            </div>
            <div class="card-body">
                <canvas id="chartDisciplinas"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card text-bg-dark shadow-sm card-chart">
            <div class="card-header border-0 bg-transparent">
                <i class="bi bi-bar-chart"></i> Status LDP (Ativos)
            </div>
            <div class="card-body">
                <canvas id="chartStatus"></canvas>
            </div>
        </div>
    </div>

</div>

<!-- EXCLUDERS + AUDITORIA --------------------------------------------------- -->
<div class="row g-4 mb-5">

    <div class="col-md-4">
        <div class="card text-bg-dark shadow-sm" style="border: 1px solid rgba(255,0,90,0.5); border-radius: 16px;">
            <div class="card-header border-0 bg-transparent">
                <i class="bi bi-person-x"></i> Usu√°rios que mais excluem
            </div>
            <div class="card-body">
                {% if top_excluidores %}
                <ul class="list-group list-group-flush">
                    {% for item in top_excluidores %}
                    <li class="list-group-item bg-transparent text-light d-flex justify-content-between">
                        <span>{{ item.usuario }}</span>
                        <span class="badge bg-danger">{{ item.qtd }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted mb-0">Nenhuma exclus√£o registrada ainda.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card text-bg-dark shadow-sm" style="border: 1px solid rgba(255,255,255,0.2); border-radius: 16px;">
            <div class="card-header border-0 bg-transparent">
                <i class="bi bi-clipboard-data"></i> Auditoria ‚Äì √öltimas A√ß√µes
            </div>
            <div class="card-body table-responsive">

                {% if auditoria_acoes %}
                <table class="table table-dark table-bordered table-sm align-middle audit-table">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Documento</th>
                            <th>Etapa</th>
                            <th>Status</th>
                            <th>Usu√°rio</th>
                            <th>Observa√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in auditoria_acoes %}
                        <tr>
                            <td>{{ log.data|date:"d/m/Y H:i" }}</td>
                            <td>
                                {% if log.documento %}{{ log.documento.codigo }} - {{ log.documento.revisao }}{% else %}‚Äî{% endif %}
                            </td>
                            <td>{{ log.etapa }}</td>
                            <td>{{ log.status }}</td>
                            <td>{{ log.usuario }}</td>
                            <td style="max-width: 260px;">
                                {% if log.observacao %}
                                    {{ log.observacao|truncatechars:80 }}
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted mb-0">Nenhum evento de auditoria registrado.</p>
                {% endif %}

            </div>
        </div>
    </div>

</div>

<!-- CHART.JS ---------------------------------------------------------------- -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const discLabels = {{ disc_labels|safe }};
const discData = {{ disc_data|safe }};
const statusLabels = {{ status_labels|safe }};
const statusData = {{ status_data|safe }};

new Chart(document.getElementById('chartDisciplinas'), {
    type: 'bar',
    data: { 
        labels: discLabels, 
        datasets: [{
            data: discData
        }] 
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false }},
        scales: {
            x: { ticks: { color: '#fff' }},
            y: { ticks: { color: '#fff' }}
        }
    }
});

new Chart(document.getElementById('chartStatus'), {
    type: 'doughnut',
    data: { 
        labels: statusLabels, 
        datasets: [{
            data: statusData
        }] 
    },
    options: {
        responsive: true,
        plugins: {
            legend: { labels: { color: '#fff' }}
        }
    }
});
</script>

{% endblock %}
