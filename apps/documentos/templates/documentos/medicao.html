{% extends "documentos/base.html" %}
{% load static %}

{% block body_attrs %}class="page-medicao"{% endblock %}

{% block title %}Medi&ccedil;&atilde;o &ndash; GED Profissional



{% endblock %}

{% block content %}
<div class="medicao-page">
<div class="doc-wrapper page-medicao">

<div class="page-header">
    <div class="medicao-hero">
        <h1 class="medicao-h1">
            <i class="bi bi-cash-coin me-2"></i>Medi&ccedil;&atilde;o &ndash; Relat&oacute;rio Financeiro</h1>
        <div class="medicao-subtitle">
            Acompanhe os totais por tipo de documento e exporte os resultados.
        </div>
    </div>
</div>


<div class="medicao-card medicao-card--dark mb-4">
    <form method="get" class="medicao-filtros medicao-form">
        <div>
            <label class="form-label">Projeto</label>
            <select class="form-select medicao-native-select" name="projeto" data-medicao-native="1">
                <option value="">Todos</option>
                {% for p in projetos %}
                    <option value="{{ p }}" {% if filtros.projeto == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
            </select>
<div class="medicao-select" data-medicao-select>
  <button type="button" class="medicao-select-btn" aria-haspopup="listbox" aria-expanded="false">
    <span class="medicao-select-value" data-medicao-value>Selecionar</span>
    <span class="medicao-select-caret" aria-hidden="true"></span>
  </button>
  <div class="medicao-select-pop" role="listbox" tabindex="-1"></div>
</div>

        </div>

        <div>
            <label class="form-label">Disciplina</label>
            <select class="form-select medicao-native-select" name="disciplina" data-medicao-native="1">
                <option value="">Todos</option>
                {% for d in disciplinas %}
                    <option value="{{ d }}" {% if filtros.disciplina == d %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
            </select>
<div class="medicao-select" data-medicao-select>
  <button type="button" class="medicao-select-btn" aria-haspopup="listbox" aria-expanded="false">
    <span class="medicao-select-value" data-medicao-value>Selecionar</span>
    <span class="medicao-select-caret" aria-hidden="true"></span>
  </button>
  <div class="medicao-select-pop" role="listbox" tabindex="-1"></div>
</div>

        </div>

        <div>
            <label class="form-label">Fase</label>
            <select class="form-select medicao-native-select" name="fase" data-medicao-native="1">
                <option value="">Todos</option>
                {% for f in fases %}
                    <option value="{{ f }}" {% if filtros.fase == f %}selected{% endif %}>{{ f }}</option>
                {% endfor %}
            </select>
<div class="medicao-select" data-medicao-select>
  <button type="button" class="medicao-select-btn" aria-haspopup="listbox" aria-expanded="false">
    <span class="medicao-select-value" data-medicao-value>Selecionar</span>
    <span class="medicao-select-caret" aria-hidden="true"></span>
  </button>
  <div class="medicao-select-pop" role="listbox" tabindex="-1"></div>
</div>

        </div>

        <div>
            <label class="form-label">Tipo Doc</label>
            <select class="form-select medicao-native-select" name="tipo_doc" data-medicao-native="1">
                <option value="">Todos</option>
                {% for t in tipos %}
                    <option value="{{ t }}" {% if filtros.tipo_doc == t %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
            </select>
<div class="medicao-select" data-medicao-select>
  <button type="button" class="medicao-select-btn" aria-haspopup="listbox" aria-expanded="false">
    <span class="medicao-select-value" data-medicao-value>Selecionar</span>
    <span class="medicao-select-caret" aria-hidden="true"></span>
  </button>
  <div class="medicao-select-pop" role="listbox" tabindex="-1"></div>
</div>

        </div>

        <div>
            <label class="form-label">Status Documento</label>
            <select class="form-select medicao-native-select" name="status_documento" data-medicao-native="1">
                <option value="">Todos</option>
                {% for s in status_docs %}
                    <option value="{{ s }}" {% if filtros.status_documento == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
<div class="medicao-select" data-medicao-select>
  <button type="button" class="medicao-select-btn" aria-haspopup="listbox" aria-expanded="false">
    <span class="medicao-select-value" data-medicao-value>Selecionar</span>
    <span class="medicao-select-caret" aria-hidden="true"></span>
  </button>
  <div class="medicao-select-pop" role="listbox" tabindex="-1"></div>
</div>

        </div>

        <div>
            <label class="form-label">Status Emissão</label>
            <select class="form-select medicao-native-select" name="status_emissao" data-medicao-native="1">
                <option value="">Todos</option>
                {% for s in status_emissoes %}
                    <option value="{{ s }}" {% if filtros.status_emissao == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
<div class="medicao-select" data-medicao-select>
  <button type="button" class="medicao-select-btn" aria-haspopup="listbox" aria-expanded="false">
    <span class="medicao-select-value" data-medicao-value>Selecionar</span>
    <span class="medicao-select-caret" aria-hidden="true"></span>
  </button>
  <div class="medicao-select-pop" role="listbox" tabindex="-1"></div>
</div>

        </div>

        <div>
            <label class="form-label">Busca</label>
            <input type="text" class="form-control" name="q" value="{{ filtros.q }}" placeholder="Codigo, titulo ou parte do codigo">
        </div>

        <div class="medicao-actions">
            <button type="submit" class="btn btn-primary btn-sm">Aplicar filtros</button>
            <a href="{% url 'documentos:medicao' %}" class="btn btn-outline-secondary btn-sm">Limpar</a>
            <a href="{% url 'documentos:exportar_medicao_excel' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-outline-secondary btn-sm btn-exportar">
                <i class="bi bi-file-earmark-excel"></i> Exportar Excel
            </a>
        </div>
    </form>
</div>


<!-- ============================
     KPIs
============================ -->
<div id="medicao-kpis" class="medicao-kpis">
<div class="medicao-kpis mb-4">
    <div class="totais-box kpi-card medicao-kpi medicao-kpi-card">
        <div class="medicao-kpi-label kpi-label">Total Docs</div>
        <div class="medicao-kpi-value kpi-value">{{ total_docs|default:0 }}</div>
    </div>
    <div class="totais-box kpi-card medicao-kpi medicao-kpi-card">
        <div class="medicao-kpi-label kpi-label">Emitidos</div>
        <div class="medicao-kpi-value kpi-value">{{ emitidos_total|default:0 }}</div>
    </div>
    <div class="totais-box kpi-card medicao-kpi medicao-kpi-card">
        <div class="medicao-kpi-label kpi-label">Não Recebidos</div>
        <div class="medicao-kpi-value kpi-value">{{ nao_recebidos_total|default:0 }}</div>
    </div>
    <div class="totais-box kpi-card medicao-kpi medicao-kpi-card">
        <div class="medicao-kpi-label kpi-label">Total USD</div>
        <div class="medicao-kpi-value kpi-value">US$ {{ total_usd|default:"0,00" }}</div>
    </div>
    <div class="totais-box kpi-card medicao-kpi medicao-kpi-card">
        <div class="medicao-kpi-label kpi-label">Total BRL</div>
        <div class="medicao-kpi-value kpi-value">R$ {{ total_brl|default:"0,00" }}</div>
    </div>
    <div class="totais-box kpi-card medicao-kpi medicao-kpi-card">
        <div class="medicao-kpi-label kpi-label">Ticket médio USD</div>
        <div class="medicao-kpi-value kpi-value">US$ {{ ticket_medio_usd|default:"0,00" }}</div>
    </div>
</div>
</div>




<!-- ============================
     TABELA PRINCIPAL
============================ -->
<div id="medicao-resumo">
<div class="medicao-card medicao-card--dark">

    <h4 class="medicao-title mb-3">
        <i class="bi bi-ui-checks-grid"></i> Resumo Financeiro por Tipo de Documento
    </h4>

    <div class="table-responsive medicao-table-wrap">
        <table class="table medicao-table table-finance">
            <colgroup>
                <col class="c-tipo">
                <col class="c-total">
                <col class="c-emitidos">
                <col class="c-naorec">
                <col class="c-usd-e">
                <col class="c-brl-e">
                <col class="c-usd-nr">
                <col class="c-brl-nr">
            </colgroup>
            <thead>
                <tr>
                    <th class="medicao-col-left">Tipo Doc</th>
                    <th class="medicao-col-center">Total</th>
                    <th class="medicao-col-center">Emitidos</th>
                    <th class="medicao-col-center">Não Recebidos</th>
                    <th class="medicao-col-right">Valor Emitidos (USD)</th>
                    <th class="medicao-col-right">Valor Emitidos (BRL)</th>
                    <th class="medicao-col-right">Valor Não Recebidos (USD)</th>
                    <th class="medicao-col-right">Valor Não Recebidos (BRL)</th>
                </tr>
            </thead>

            <tbody>
                {% for r in resumo %}
                <tr>
                    <td class="t-left medicao-col-left fw-bold text-info">{{ r.tipo_doc|default:"-" }}</td>
                    <td class="t-right medicao-col-center">{{ r.total|default:0 }}</td>
                    <td class="t-right medicao-col-center">{{ r.emitidos|default:0 }}</td>
                    <td class="t-right medicao-col-center">{{ r.nao_recebidos|default:0 }}</td>
                    <td class="t-right medicao-col-right">US$ {{ r.valor_emitidos_usd|default:0 }}</td>
                    <td class="t-right medicao-col-right">R$ {{ r.valor_emitidos_brl|default:0 }}</td>
                    <td class="t-right medicao-col-right">US$ {{ r.valor_nr_usd|default:0 }}</td>
                    <td class="t-right medicao-col-right">R$ {{ r.valor_nr_brl|default:0 }}</td>
                </tr>
                {% endfor %}
            </tbody>

            <tfoot>
                <tr class="row-total medicao-total-row total">
                    <td class="t-left medicao-col-left">Total Geral</td>
                    <td class="t-right medicao-col-center">{{ total_geral.total|default:0 }}</td>
                    <td class="t-right medicao-col-center">{{ total_geral.emitidos|default:0 }}</td>
                    <td class="t-right medicao-col-center">{{ total_geral.nao_recebidos|default:0 }}</td>
                    <td class="t-right medicao-col-right">US$ {{ total_geral.valor_emitidos_usd|default:0 }}</td>
                    <td class="t-right medicao-col-right">R$ {{ total_geral.valor_emitidos_brl|default:0 }}</td>
                    <td class="t-right medicao-col-right">US$ {{ total_geral.valor_nao_recebidos_usd|default:0 }}</td>
                    <td class="t-right medicao-col-right">R$ {{ total_geral.valor_nao_recebidos_brl|default:0 }}</td>
                </tr>
            </tfoot>

        </table>
    </div>
</div>
</div>




<!-- ============================
     GRÁFICOS
============================ -->

<div id="medicao-graficos" class="medicao-graficos">
<h4 class="medicao-title mt-5 mb-4">
    <i class="bi bi-bar-chart"></i> Gr&aacute;ficos da Medi&ccedil;&atilde;o
</h4>

{% if tem_dados_medicao %}
<div class="medicao-charts mb-5">
    <div class="medicao-chart-card">
      <div class="medicao-chart-head">
        <div class="medicao-chart-title">Totais por Tipo de Documento</div>
        <div class="medicao-chart-meta">Gerado a partir do resumo</div>
      </div>
      <div class="medicao-chart-body" style="height:280px;">
        {% if chart1_url %}
        <img src="{{ chart1_url }}" alt="Totais por Tipo de Documento" class="chart-img">
        {% else %}
        <canvas id="medicaoChartTotais" class="medicao-chart"></canvas>
        {% endif %}
      </div>
    </div>

    <div class="medicao-chart-card">
      <div class="medicao-chart-head">
        <div class="medicao-chart-title">Valores Emitidos por Tipo (USD)</div>
        <div class="medicao-chart-meta">Gerado a partir do resumo</div>
      </div>
      <div class="medicao-chart-body" style="height:280px;">
        {% if chart2_url %}
        <img src="{{ chart2_url }}" alt="Valores Emitidos por Tipo (USD)" class="chart-img">
        {% else %}
        <canvas id="medicaoChartValoresUSD" class="medicao-chart"></canvas>
        {% endif %}
      </div>
    </div>
</div>
{% else %}
<div class="medicao-charts mb-5">
    <div class="medicao-chart-card">
      <div class="medicao-chart-head">
        <div class="medicao-chart-title">Distribui&ccedil;&atilde;o por Disciplina</div>
        <div class="medicao-chart-meta">Gerado a partir do resumo</div>
      </div>
      <div class="medicao-chart-body" style="height:280px;">
        <div class="medicao-chart-fallback">Os gr&aacute;ficos ser&atilde;o exibidos quando houver dados suficientes.</div>
      </div>
    </div>

    <div class="medicao-chart-card">
      <div class="medicao-chart-head">
        <div class="medicao-chart-title">Status Geral</div>
        <div class="medicao-chart-meta">Gerado a partir do resumo</div>
      </div>
      <div class="medicao-chart-body" style="height:280px;">
        <div class="medicao-chart-fallback">Os gr&aacute;ficos ser&atilde;o exibidos quando houver dados suficientes.</div>
      </div>
    </div>
</div>
{% endif %}

</div>




















<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function () {
  function parseMoneyToNumber(txt) {
    // aceita "US$ 979.00", "USS 979.00", "R$ 1.234,56", etc.
    if (!txt) return 0;
    const s = String(txt).replace(/\s+/g, ' ').trim();
    const cleaned = s.replace(/[^\d.,-]/g, '');
    let n = cleaned;
    const hasComma = n.indexOf(',') !== -1;
    const hasDot = n.indexOf('.') !== -1;
    if (hasComma && hasDot) {
      n = n.replace(/\./g, '').replace(',', '.');
    } else if (hasComma && !hasDot) {
      n = n.replace(',', '.');
    }
    const val = Number(n);
    return Number.isFinite(val) ? val : 0;
  }

  function parseIntSafe(txt) {
    if (!txt) return 0;
    const m = String(txt).match(/-?\d+/);
    return m ? parseInt(m[0], 10) : 0;
  }

  function getResumoRows() {
    const table = document.querySelector('#medicao-resumo table.medicao-table');
    if (!table) return [];
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    return rows.filter(tr => {
      if (tr.classList.contains('total')) return false;
      const first = tr.querySelector('td');
      if (!first) return false;
      const t = first.textContent.trim().toLowerCase();
      return t !== 'total geral' && t !== 'total';
    });
  }

  function extractData() {
    const rows = getResumoRows();
    const labels = [];
    const totalsDocs = [];
    const valoresUSD = [];
    rows.forEach(tr => {
      const tds = Array.from(tr.querySelectorAll('td'));
      if (tds.length < 5) return;
      const tipo = (tds[0]?.textContent || '').trim();
      if (!tipo) return;
      labels.push(tipo);
      totalsDocs.push(parseIntSafe(tds[1]?.textContent));
      valoresUSD.push(parseMoneyToNumber(tds[4]?.textContent));
    });
    return { labels, totalsDocs, valoresUSD };
  }

  function ensureCanvas(id) {
    const el = document.getElementById(id);
    return el && el.getContext ? el : null;
  }

  function destroyOldCharts() {
    if (window.__medicaoCharts) {
      Object.values(window.__medicaoCharts).forEach(ch => {
        try { ch.destroy(); } catch(e) {}
      });
    }
    window.__medicaoCharts = {};
  }

  const MEDICAO_CHART_THEME = {
    grid: 'rgba(255,255,255,.08)',
    ticks: 'rgba(255,255,255,.78)',
    tooltipBg: 'rgba(2,6,23,.92)',
    tooltipBorder: 'rgba(255,255,255,.12)'
  };

  function render() {
    const c1 = ensureCanvas('medicaoChartTotais');
    const c2 = ensureCanvas('medicaoChartValoresUSD');
    if (!c1 || !c2) return;
    const { labels, totalsDocs, valoresUSD } = extractData();
    if (!labels.length) return;
    if (typeof Chart === 'undefined') return;
    destroyOldCharts();

    window.__medicaoCharts.totais = new Chart(c1.getContext('2d'), {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Total (docs)', data: totalsDocs }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            backgroundColor: MEDICAO_CHART_THEME.tooltipBg,
            borderColor: MEDICAO_CHART_THEME.tooltipBorder,
            borderWidth: 1,
            titleColor: 'rgba(255,255,255,.92)',
            bodyColor: 'rgba(255,255,255,.85)',
            displayColors: false
          }
        },
        scales: {
          x: { grid: { color: MEDICAO_CHART_THEME.grid }, ticks: { color: MEDICAO_CHART_THEME.ticks } },
          y: { beginAtZero: true, grid: { color: MEDICAO_CHART_THEME.grid }, ticks: { color: MEDICAO_CHART_THEME.ticks } }
        }
      }
    });

    window.__medicaoCharts.valoresUSD = new Chart(c2.getContext('2d'), {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Valor Emitidos (USD)', data: valoresUSD }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            backgroundColor: MEDICAO_CHART_THEME.tooltipBg,
            borderColor: MEDICAO_CHART_THEME.tooltipBorder,
            borderWidth: 1,
            titleColor: 'rgba(255,255,255,.92)',
            bodyColor: 'rgba(255,255,255,.85)',
            displayColors: false
          }
        },
        scales: {
          x: { grid: { color: MEDICAO_CHART_THEME.grid }, ticks: { color: MEDICAO_CHART_THEME.ticks } },
          y: { beginAtZero: true, grid: { color: MEDICAO_CHART_THEME.grid }, ticks: { color: MEDICAO_CHART_THEME.ticks } }
        }
      }
    });
  }

  function closeAll(except){
    document.querySelectorAll('.medicao-select.is-open').forEach(el=>{
      if(except && el===except) return;
      el.classList.remove('is-open');
      const btn = el.querySelector('.medicao-select-btn');
      if(btn) btn.setAttribute('aria-expanded','false');
    });
  }

  function build(select){
    const wrap = select.nextElementSibling;
    if(!wrap || !wrap.matches('.medicao-select[data-medicao-select]')) return;

    const btn = wrap.querySelector('.medicao-select-btn');
    const pop = wrap.querySelector('.medicao-select-pop');
    const valueEl = wrap.querySelector('[data-medicao-value]');

    pop.innerHTML = '';
    const opts = Array.from(select.options || []);
    opts.forEach((o)=>{
      const item = document.createElement('button');
      item.type = 'button';
      item.className = 'medicao-select-opt';
      item.setAttribute('role','option');
      item.dataset.value = o.value;
      item.textContent = o.textContent || o.label || '';
      if(o.disabled) item.disabled = true;
      if(select.value === o.value) item.classList.add('is-selected');
      item.addEventListener('click', ()=>{
        select.value = o.value;
        pop.querySelectorAll('.medicao-select-opt').forEach(x=>x.classList.remove('is-selected'));
        item.classList.add('is-selected');
        valueEl.textContent = item.textContent;
        closeAll();
      });
      pop.appendChild(item);
    });

    const current = opts.find(o=>o.value===select.value) || opts[0];
    valueEl.textContent = current ? (current.textContent || current.label || 'Selecionar') : 'Selecionar';

    btn.addEventListener('click', ()=>{
      const isOpen = wrap.classList.contains('is-open');
      if(isOpen){
        wrap.classList.remove('is-open');
        btn.setAttribute('aria-expanded','false');
      } else {
        closeAll(wrap);
        wrap.classList.add('is-open');
        btn.setAttribute('aria-expanded','true');
        setTimeout(()=>pop.focus(), 0);
      }
    });

    btn.addEventListener('keydown', (e)=>{
      if(e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        btn.click();
      }
    });

    pop.addEventListener('keydown', (e)=>{
      const items = Array.from(pop.querySelectorAll('.medicao-select-opt:not(:disabled)'));
      const i = items.findIndex(x=>x.classList.contains('is-selected'));
      if(e.key === 'Escape'){ e.preventDefault(); closeAll(); btn.focus(); return; }
      if(!items.length) return;
      if(e.key === 'ArrowDown'){
        e.preventDefault();
        const next = items[Math.min(items.length-1, Math.max(0, i+1))];
        next.click(); next.focus();
      } else if(e.key === 'ArrowUp'){
        e.preventDefault();
        const prev = items[Math.max(0, i-1)];
        prev.click(); prev.focus();
      }
    });

    select.addEventListener('change', ()=>{
      const opt = opts.find(o=>o.value===select.value);
      if(opt) valueEl.textContent = opt.textContent || opt.label || '';
      pop.querySelectorAll('.medicao-select-opt').forEach(x=>{
        x.classList.toggle('is-selected', x.dataset.value === select.value);
      });
    });
  }

  document.querySelectorAll('select[data-medicao-native="1"]').forEach(sel=>{
    build(sel);
  });

  document.addEventListener('click', (e)=>{
    if(!e.target.closest('.medicao-select')) closeAll();
  });

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', render);
  } else {
    render();
  }
})();
</script>

{% endblock %}
