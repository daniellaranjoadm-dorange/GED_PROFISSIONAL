{% extends "documentos/base.html" %}
{% load static %}

{% block title %}Medição – GED Profissional{% endblock %}

{% block content %}

<div class="doc-wrapper">

<style>
/* ============================
   MEDIÇÃO – PREMIUM v2.2
   (CSS 100% escopado em .doc-wrapper)
   ============================ */

.doc-wrapper{
  --gap: clamp(12px, 1.2vw, 18px);
  --radius: 14px;
  --radius-lg: 18px;

  --accent: var(--accent-blue, #38bdf8);
  --ink: var(--text, #0f172a);
  --muted: rgba(15, 23, 42, .66);

  --card-bg: var(--card-bg, rgba(255,255,255,.86));
  --card-bg-2: rgba(255,255,255,.78);
  --border: rgba(15, 23, 42, .12);
  --shadow: 0 16px 38px rgba(2, 6, 23, .10);
  --shadow-soft: 0 10px 24px rgba(2, 6, 23, .08);
}

/* Header da página */
.doc-wrapper .page-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: var(--gap);
  margin-bottom: var(--gap);
}

.doc-wrapper .medicao-title{
  margin: 0;
  font-size: clamp(26px, 2.2vw, 34px);
  line-height: 1.12;
  letter-spacing: -0.02em;
  color: var(--accent);
  text-shadow: 0 4px 12px rgba(56,189,248,.12); /* glow bem mais sutil */
}

.doc-wrapper .page-subtitle{
  margin-top: 6px;
  color: var(--muted);
  font-size: .95rem;
}

/* Cards / KPIs */
.doc-wrapper .totais-box{
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-soft);
  padding: 14px 16px;
  min-height: 74px;
}

.doc-wrapper .totais-box .label,
.doc-wrapper .totais-box small,
.doc-wrapper .totais-box .kpi-label{
  color: var(--muted);
  font-size: .82rem;
  font-weight: 600;
  letter-spacing: .02em;
  text-transform: none;
}

.doc-wrapper .totais-box .valor,
.doc-wrapper .totais-box .kpi-value{
  margin-top: 4px;
  font-size: 1.25rem;
  font-weight: 800;
  color: var(--ink);
  font-variant-numeric: tabular-nums;
}

/* Filtros */
.doc-wrapper .medicao-filtros{
  display: grid;
  grid-template-columns: repeat(4, minmax(180px, 1fr));
  gap: 12px;
  align-items: end;
}

.doc-wrapper .medicao-filtros .form-label{
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
  margin-bottom: 4px;
}

.doc-wrapper .medicao-actions{
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
}

.doc-wrapper .medicao-kpis{
  display: grid;
  grid-template-columns: repeat(3, minmax(180px, 1fr));
  gap: 12px;
}

/* Botão export (mais corporativo e consistente) */
.doc-wrapper .btn-exportar{
  border-radius: 999px;
  padding: 10px 14px;
  border: 1px solid rgba(224,96,0,.35);
  background: rgba(224,96,0,.10);
  color: var(--ink);
  box-shadow: 0 10px 22px rgba(2, 6, 23, .08);
  transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
  opacity: 1;
}

.doc-wrapper .btn-exportar:hover{
  transform: translateY(-1px);
  background: rgba(224,96,0,.16);
  box-shadow: 0 16px 32px rgba(2, 6, 23, .12);
}

.doc-wrapper .btn-exportar[disabled],
.doc-wrapper .btn-exportar.disabled{
  opacity: .55;
  cursor: not-allowed;
  filter: grayscale(.2);
}

/* Tabela */
.doc-wrapper .medicao-card{
  background: var(--card-bg-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  padding: 12px;
}

.doc-wrapper .charts-grid{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.doc-wrapper .chart-card{
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 14px;
  box-shadow: 0 8px 24px rgba(2,6,23,0.08);
  padding: 16px;
  min-height: 120px;
}

.doc-wrapper .chart-card h6{
  font-weight: 700;
  color: #0f172a;
  margin-bottom: 8px;
}

.doc-wrapper .chart-card p{
  color: #475569;
  margin-bottom: 0;
}

.doc-wrapper .chart-img{
  width: 100%;
  height: auto;
  display: block;
  border-radius: 12px;
  background: #ffffff;
}

.doc-wrapper .table-finance{
  width: 100%;
  table-layout: fixed;
  border-collapse: separate;
  border-spacing: 0;
  overflow: hidden;
  border-radius: 12px;
}

.doc-wrapper .table-finance th,
.doc-wrapper .table-finance td{
  padding: 10px 12px;
  font-size: 13px;
}

.doc-wrapper .table-finance thead th{
  background: rgba(2, 132, 199, 0.10);
  color: #0f172a;
  font-weight: 700;
  letter-spacing: .02em;
  padding: 10px 12px;
  border-bottom: 1px solid #cbd5e1;
  white-space: nowrap;
  font-size: 12px;
  text-transform: none;
}

.doc-wrapper .table-finance tbody td{
  border-bottom: 1px solid rgba(203,213,225,.55);
  color: rgba(15,23,42,.88);
  font-variant-numeric: tabular-nums;
}

.doc-wrapper .table-finance .t-left{ text-align: left; }
.doc-wrapper .table-finance .t-right{ text-align: right; font-variant-numeric: tabular-nums; }

.doc-wrapper .table-finance col.c-tipo { width: 120px; }
.doc-wrapper .table-finance col.c-total,
.doc-wrapper .table-finance col.c-emitidos,
.doc-wrapper .table-finance col.c-naorec { width: 80px; }
.doc-wrapper .table-finance col.c-usd-e,
.doc-wrapper .table-finance col.c-brl-e,
.doc-wrapper .table-finance col.c-usd-nr,
.doc-wrapper .table-finance col.c-brl-nr { width: 160px; }

/* zebra discreta + hover corporativo (sem scale) */
.doc-wrapper .table-finance tbody tr:nth-child(even){
  background: rgba(2, 6, 23, .02);
}
.doc-wrapper .table-finance tbody tr:hover{
  background: rgba(56,189,248,.08);
}

.doc-wrapper .table-finance tfoot .row-total td{
  background: rgba(2, 132, 199, 0.14);
  color: #0f172a;
  font-weight: 800;
  padding: 10px 12px;
  border-top: 2px solid rgba(2,132,199,.35);
  border-bottom: 0;
  vertical-align: middle;
}
.doc-wrapper .table-finance tfoot .row-total td:first-child{
  border-bottom-left-radius: 10px;
}
.doc-wrapper .table-finance tfoot .row-total td:last-child{
  border-bottom-right-radius: 10px;
}

/* badges de cor (mantém sua intenção sem neon gritante) */
.doc-wrapper .valor-usd{ color:#0ea5e9; font-weight:800; }
.doc-wrapper .valor-brl{ color:#16a34a; font-weight:800; }
.doc-wrapper .valor-nr { color:#dc2626; font-weight:800; }

.doc-wrapper hr, .doc-wrapper .divider, .doc-wrapper .medicao-divider{
  display:none !important;
}
.doc-wrapper::before,
.doc-wrapper::after{
  content: none !important;
  display: none !important;
}
.doc-wrapper .page-area::before,
.doc-wrapper .page-area::after,
.doc-wrapper .content::before,
.doc-wrapper .content::after,
.doc-wrapper main::before,
.doc-wrapper main::after,
.doc-wrapper .container::before,
.doc-wrapper .container::after{
  content: none !important;
  display: none !important;
  border: 0 !important;
  outline: 0 !important;
  box-shadow: none !important;
}
.doc-wrapper{
  border-bottom: 0 !important;
  outline: 0 !important;
}
.doc-wrapper .page-area,
.doc-wrapper .content,
.doc-wrapper main,
.doc-wrapper .container{
  border-bottom: 0 !important;
  outline: 0 !important;
}
.doc-wrapper .divider,
.doc-wrapper .separator,
.doc-wrapper .footer-line{
  display: none !important;
}

/* Responsivo */
@media (max-width: 992px){
  .doc-wrapper .page-header{ flex-direction: column; align-items: stretch; }
  .doc-wrapper .btn-exportar{ align-self: flex-start; }
  .doc-wrapper .table-finance{ font-size: .86rem; }
  .doc-wrapper .charts-grid{ grid-template-columns: 1fr; }
  .doc-wrapper .medicao-filtros{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }
  .doc-wrapper .medicao-kpis{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }
}

@media (max-width: 640px){
  .doc-wrapper .medicao-filtros{ grid-template-columns: 1fr; }
  .doc-wrapper .medicao-kpis{ grid-template-columns: 1fr; }
}
</style>



<div class="page-header">
    <div>
        <h1 class="medicao-title fw-bold">
            <i class="bi bi-cash-coin me-2"></i>Medição – Relatório Financeiro
        </h1>
        <div class="page-subtitle">
            Acompanhe os totais por tipo de documento e exporte os resultados.
        </div>
    </div>
</div>


<div class="medicao-card mb-4">
    <form method="get" class="medicao-filtros">
        <div>
            <label class="form-label">Projeto</label>
            <select class="form-select" name="projeto">
                <option value="">Todos</option>
                {% for p in projetos %}
                    <option value="{{ p }}" {% if filtros.projeto == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="form-label">Disciplina</label>
            <select class="form-select" name="disciplina">
                <option value="">Todos</option>
                {% for d in disciplinas %}
                    <option value="{{ d }}" {% if filtros.disciplina == d %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="form-label">Fase</label>
            <select class="form-select" name="fase">
                <option value="">Todos</option>
                {% for f in fases %}
                    <option value="{{ f }}" {% if filtros.fase == f %}selected{% endif %}>{{ f }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="form-label">Tipo Doc</label>
            <select class="form-select" name="tipo_doc">
                <option value="">Todos</option>
                {% for t in tipos %}
                    <option value="{{ t }}" {% if filtros.tipo_doc == t %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="form-label">Status Documento</label>
            <select class="form-select" name="status_documento">
                <option value="">Todos</option>
                {% for s in status_docs %}
                    <option value="{{ s }}" {% if filtros.status_documento == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="form-label">Status Emissão</label>
            <select class="form-select" name="status_emissao">
                <option value="">Todos</option>
                {% for s in status_emissoes %}
                    <option value="{{ s }}" {% if filtros.status_emissao == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="form-label">Busca</label>
            <input type="text" class="form-control" name="q" value="{{ filtros.q }}" placeholder="Código ou título">
        </div>

        <div class="medicao-actions">
            <button type="submit" class="btn btn-primary">Aplicar filtros</button>
            <a href="{% url 'documentos:medicao' %}" class="btn btn-outline-secondary">Limpar</a>
            <a href="{% url 'documentos:exportar_medicao_excel' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-primary btn-exportar">
                <i class="bi bi-file-earmark-excel"></i> Exportar Excel
            </a>
        </div>
    </form>
</div>


<!-- ============================
     KPIs
============================ -->
<div class="medicao-kpis mb-4">
    <div class="totais-box">
        <div class="kpi-label">Total Docs</div>
        <div class="kpi-value">{{ total_docs|default:0 }}</div>
    </div>
    <div class="totais-box">
        <div class="kpi-label">Emitidos</div>
        <div class="kpi-value">{{ emitidos_total|default:0 }}</div>
    </div>
    <div class="totais-box">
        <div class="kpi-label">Não Recebidos</div>
        <div class="kpi-value">{{ nao_recebidos_total|default:0 }}</div>
    </div>
    <div class="totais-box">
        <div class="kpi-label">Total USD</div>
        <div class="kpi-value">US$ {{ total_usd|default:"0,00" }}</div>
    </div>
    <div class="totais-box">
        <div class="kpi-label">Total BRL</div>
        <div class="kpi-value">R$ {{ total_brl|default:"0,00" }}</div>
    </div>
    <div class="totais-box">
        <div class="kpi-label">Ticket médio USD</div>
        <div class="kpi-value">US$ {{ ticket_medio_usd|default:"0,00" }}</div>
    </div>
</div>




<!-- ============================
     TABELA PRINCIPAL
============================ -->
<div class="medicao-card">

    <h4 class="medicao-title mb-3">
        <i class="bi bi-ui-checks-grid"></i> Resumo Financeiro por Tipo de Documento
    </h4>

    <div class="table-responsive">
        <table class="table-finance">
            <colgroup>
                <col class="c-tipo">
                <col class="c-total">
                <col class="c-emitidos">
                <col class="c-naorec">
                <col class="c-usd-e">
                <col class="c-brl-e">
                <col class="c-usd-nr">
                <col class="c-brl-nr">
            </colgroup>
            <thead>
                <tr>
                    <th>Tipo Doc</th>
                    <th>Total</th>
                    <th>Emitidos</th>
                    <th>Não Recebidos</th>
                    <th>Valor Emitidos (USD)</th>
                    <th>Valor Emitidos (BRL)</th>
                    <th>Valor Não Recebidos (USD)</th>
                    <th>Valor Não Recebidos (BRL)</th>
                </tr>
            </thead>

            <tbody>
                {% for r in resumo %}
                <tr>
                    <td class="t-left fw-bold text-info">{{ r.tipo_doc|default:"-" }}</td>
                    <td class="t-right">{{ r.total|default:0 }}</td>
                    <td class="t-right">{{ r.emitidos|default:0 }}</td>
                    <td class="t-right">{{ r.nao_recebidos|default:0 }}</td>
                    <td class="t-right">US$ {{ r.valor_emitidos_usd|default:0 }}</td>
                    <td class="t-right">R$ {{ r.valor_emitidos_brl|default:0 }}</td>
                    <td class="t-right">US$ {{ r.valor_nr_usd|default:0 }}</td>
                    <td class="t-right">R$ {{ r.valor_nr_brl|default:0 }}</td>
                </tr>
                {% endfor %}
            </tbody>

            <tfoot>
                <tr class="row-total">
                    <td class="t-left">Total Geral</td>
                    <td class="t-right">{{ total_geral.total|default:0 }}</td>
                    <td class="t-right">{{ total_geral.emitidos|default:0 }}</td>
                    <td class="t-right">{{ total_geral.nao_recebidos|default:0 }}</td>
                    <td class="t-right">US$ {{ total_geral.valor_emitidos_usd|default:0 }}</td>
                    <td class="t-right">R$ {{ total_geral.valor_emitidos_brl|default:0 }}</td>
                    <td class="t-right">US$ {{ total_geral.valor_nao_recebidos_usd|default:0 }}</td>
                    <td class="t-right">R$ {{ total_geral.valor_nao_recebidos_brl|default:0 }}</td>
                </tr>
            </tfoot>

        </table>
    </div>
</div>




<!-- ============================
     GRÁFICOS
============================ -->
<h4 class="medicao-title mt-5 mb-4">
    <i class="bi bi-bar-chart"></i> Gráficos da Medição
</h4>

{% if tem_dados_medicao %}
<div class="charts-grid mb-5">
    <div class="chart-card">
        <h6>Totais por Tipo de Documento</h6>
        {% if chart1_url %}
        <img src="{{ chart1_url }}" alt="Totais por Tipo de Documento" class="chart-img">
        {% else %}
        <p>Gráfico em preparação.</p>
        {% endif %}
    </div>

    <div class="chart-card">
        <h6>Valores Emitidos por Tipo (USD)</h6>
        {% if chart2_url %}
        <img src="{{ chart2_url }}" alt="Valores Emitidos por Tipo (USD)" class="chart-img">
        {% else %}
        <p>Gráfico em preparação.</p>
        {% endif %}
    </div>
</div>
{% else %}
<div class="charts-grid mb-5">
    <div class="chart-card">
        <h6>Distribuição por Disciplina</h6>
        <p>Os gráficos serão exibidos quando houver dados suficientes.</p>
    </div>

    <div class="chart-card">
        <h6>Status Geral</h6>
        <p>Os gráficos serão exibidos quando houver dados suficientes.</p>
    </div>
</div>
{% endif %}


</div>

{% endblock %}
