{% extends "documentos/base.html" %}
{% load static %}

{% block title %}Medição – GED Profissional{% endblock %}

{% block content %}

<div class="doc-wrapper">

<style>
/* ============================
   MEDI??O ? PREMIUM v2.2
   (CSS 100% escopado em .doc-wrapper)
   ============================ */

.doc-wrapper{
  --gap: clamp(12px, 1.2vw, 18px);
  --radius: 14px;
  --radius-lg: 18px;

  --accent: var(--accent-blue, #38bdf8);
  --ink: var(--text, #0f172a);
  --muted: rgba(15, 23, 42, .66);

  --card-bg: var(--card-bg, rgba(255,255,255,.86));
  --card-bg-2: rgba(255,255,255,.78);
  --border: rgba(15, 23, 42, .12);
  --shadow: 0 16px 38px rgba(2, 6, 23, .10);
  --shadow-soft: 0 10px 24px rgba(2, 6, 23, .08);
}

/* Header da p?gina */
.doc-wrapper .page-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: var(--gap);
  margin-bottom: var(--gap);
}

.doc-wrapper .medicao-title{
  margin: 0;
  font-size: clamp(26px, 2.2vw, 34px);
  line-height: 1.12;
  letter-spacing: -0.02em;
  color: var(--accent);
  text-shadow: 0 6px 18px rgba(56,189,248,.18); /* glow bem mais sutil */
}

.doc-wrapper .page-subtitle{
  margin-top: 6px;
  color: var(--muted);
  font-size: .95rem;
}

/* Cards / KPIs */
.doc-wrapper .totais-box{
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-soft);
  padding: 14px 16px;
  min-height: 74px;
}

.doc-wrapper .totais-box .label,
.doc-wrapper .totais-box small,
.doc-wrapper .totais-box .kpi-label{
  color: var(--muted);
  font-size: .82rem;
  font-weight: 600;
  letter-spacing: .02em;
  text-transform: none;
}

.doc-wrapper .totais-box .valor,
.doc-wrapper .totais-box .kpi-value{
  margin-top: 4px;
  font-size: 1.25rem;
  font-weight: 800;
  color: var(--ink);
  font-variant-numeric: tabular-nums;
}

/* Bot?o export (mais corporativo e consistente) */
.doc-wrapper .btn-exportar{
  border-radius: 999px;
  padding: 10px 14px;
  border: 1px solid rgba(224,96,0,.35);
  background: rgba(224,96,0,.10);
  color: var(--ink);
  box-shadow: 0 10px 22px rgba(2, 6, 23, .08);
  transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
  opacity: 1;
}

.doc-wrapper .btn-exportar:hover{
  transform: translateY(-1px);
  background: rgba(224,96,0,.16);
  box-shadow: 0 16px 32px rgba(2, 6, 23, .12);
}

.doc-wrapper .btn-exportar[disabled],
.doc-wrapper .btn-exportar.disabled{
  opacity: .55;
  cursor: not-allowed;
  filter: grayscale(.2);
}

/* Tabela */
.doc-wrapper .medicao-card{
  background: var(--card-bg-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  padding: 12px;
}

.doc-wrapper .table-finance{
  width:100%;
  border-collapse: separate;
  border-spacing: 0;
  overflow: hidden;
  border-radius: 12px;
  font-size: .90rem;
}

.doc-wrapper .table-finance thead th{
  background: rgba(56,189,248,.12);
  color: rgba(15,23,42,.85);
  font-weight: 800;
  letter-spacing: .02em;
  padding: 10px 12px;
  border-bottom: 1px solid rgba(15,23,42,.10);
  white-space: nowrap;
}

.doc-wrapper .table-finance tbody td{
  padding: 10px 12px;
  border-bottom: 1px solid rgba(15,23,42,.06);
  color: rgba(15,23,42,.88);
  font-variant-numeric: tabular-nums;
}

/* primeira coluna (tipo doc) alinhada ? esquerda, n?meros ? direita */
.doc-wrapper .table-finance thead th:first-child,
.doc-wrapper .table-finance tbody td:first-child{ text-align:left; }

.doc-wrapper .table-finance thead th:not(:first-child),
.doc-wrapper .table-finance tbody td:not(:first-child){ text-align:right; }

/* zebra discreta + hover corporativo (sem scale) */
.doc-wrapper .table-finance tbody tr:nth-child(even){
  background: rgba(2, 6, 23, .02);
}
.doc-wrapper .table-finance tbody tr:hover{
  background: rgba(56,189,248,.08);
}

/* linha total (assume que ? a ?ltima linha) */
.doc-wrapper .table-finance tbody tr:last-child{
  background: rgba(2, 6, 23, .04);
  font-weight: 900;
}
.doc-wrapper .table-finance tbody tr:last-child td{
  border-top: 2px solid rgba(15,23,42,.12);
}

/* ?badges? de cor (mant?m sua inten??o sem neon gritante) */
.doc-wrapper .valor-usd{ color:#0ea5e9; font-weight:800; }
.doc-wrapper .valor-brl{ color:#16a34a; font-weight:800; }
.doc-wrapper .valor-nr { color:#dc2626; font-weight:800; }

/* Responsivo */
@media (max-width: 992px){
  .doc-wrapper .page-header{ flex-direction: column; align-items: stretch; }
  .doc-wrapper .btn-exportar{ align-self: flex-start; }
  .doc-wrapper .table-finance{ font-size: .86rem; }
}
</style>



<div class="page-header">
    <div>
        <h1 class="text-info fw-bold" style="text-shadow: 0 0 8px #00eaff;">
            <i class="bi bi-cash-coin me-2"></i>Medição – Relatório Financeiro
        </h1>
        <div class="page-subtitle">
            Acompanhe os totais por tipo de documento e exporte os resultados.
        </div>
    </div>
</div>



<!-- ============================
     KPIs
============================ -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="totais-box">
            <h5 class="text-info fw-bold">Taxa de câmbio fixa</h5>
            <p class="valor-brl">R$ 5,7642</p>
        </div>
    </div>

    <div class="col-md-4">
        <div class="totais-box">
            <h5 class="text-info fw-bold">Valor por documento</h5>
            <p class="valor-usd">US$ {{ VALOR_MEDICAO_USD }}</p>
        </div>
    </div>

    <div class="col-md-4 text-end">
        <a href="{% url 'documentos:exportar_medicao_excel' %}" class="btn btn-primary btn-exportar px-4 py-2">
            <i class="bi bi-file-earmark-excel"></i> Exportar Excel
        </a>
    </div>
</div>




<!-- ============================
     TABELA PRINCIPAL
============================ -->
<div class="medicao-card">

    <h4 class="medicao-title mb-3">
        <i class="bi bi-ui-checks-grid"></i> Resumo Financeiro por Tipo de Documento
    </h4>

    <div class="table-responsive">
        <table class="table-finance">
            <thead>
                <tr>
                    <th>Tipo Doc</th>
                    <th>Total</th>
                    <th>Emitidos</th>
                    <th>Não Recebidos</th>

                    <th>Valor Emitidos (USD)</th>
                    <th>Valor Emitidos (BRL)</th>

                    <th>Valor Não Recebidos (USD)</th>
                    <th>Valor Não Recebidos (BRL)</th>
                </tr>
            </thead>

            <tbody>
                {% for linha in linhas %}
                <tr>
                    <td class="fw-bold text-info">{{ linha.tipo_doc }}</td>
                    <td>{{ linha.total }}</td>
                    <td class="text-primary fw-bold">{{ linha.emitidos }}</td>
                    <td class="text-danger fw-bold">{{ linha.nao_recebidos }}</td>

                    <td class="valor-usd">US$ {{ linha.valor_emitidos_usd }}</td>
                    <td class="valor-brl">R$ {{ linha.valor_emitidos_brl }}</td>

                    <td class="valor-nr">US$ {{ linha.valor_nr_usd }}</td>
                    <td class="valor-nr">R$ {{ linha.valor_nr_brl }}</td>
                </tr>
                {% endfor %}
            </tbody>

            <tfoot>
                <tr style="background: rgba(0,255,200,0.15); font-weight:bold;">
                    <td>Total Geral</td>
                    <td>{{ totais.total_docs }}</td>
                    <td>{{ totais.total_emitidos }}</td>
                    <td>{{ totais.total_nao_recebidos }}</td>

                    <td class="valor-usd">US$ {{ totais.total_emitidos_usd }}</td>
                    <td class="valor-brl">R$ {{ totais.total_emitidos_brl }}</td>

                    <td class="valor-nr">US$ {{ totais.total_nr_usd }}</td>
                    <td class="valor-nr">R$ {{ totais.total_nr_brl }}</td>
                </tr>
            </tfoot>

        </table>
    </div>
</div>




<!-- ============================
     GRÁFICOS
============================ -->
<h4 class="medicao-title mt-5 mb-4">
    <i class="bi bi-bar-chart"></i> Gráficos da Medição
</h4>

<div class="row g-4 mb-5 charts-area">
    <div class="col-md-6">
        <div class="medicao-card">
            <canvas id="chartMedicaoBars"></canvas>
        </div>
    </div>

    <div class="col-md-6">
        <div class="medicao-card">
            <canvas id="chartMedicaoPie"></canvas>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const tipos = {{ tipos_js|safe }};
    const valoresUSD = {{ usd_js|safe }};
    const valoresBRL = {{ brl_js|safe }};

    /* GRÁFICO DE BARRAS */
    new Chart(document.getElementById("chartMedicaoBars"), {
        type: "bar",
        data: {
            labels: tipos,
            datasets: [{
                label: "Valor Total (BRL)",
                data: valoresBRL,
                backgroundColor: "rgba(0, 200, 255, 0.6)",
                borderColor: "rgba(0, 200, 255, 1)",
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                legend: {
                    labels: { color: "#fff" }
                }
            },
            scales: {
                x: { ticks: { color: "#fff" } },
                y: { ticks: { color: "#fff" } }
            }
        }
    });

    /* GRÁFICO DE PIZZA */
    new Chart(document.getElementById("chartMedicaoPie"), {
        type: "pie",
        data: {
            labels: tipos,
            datasets: [{
                data: valoresUSD,
                backgroundColor: [
                    "#00eaff", "#00ffaa", "#ffae00", "#ff0099",
                    "#ffaa00", "#33ccff", "#66ff66", "#ff6666",
                    "#0099ff", "#ff9900", "#cc33ff", "#33ffcc"
                ]
            }]
        },
        options: {
            plugins: {
                legend: {
                    labels: { color: "#fff" }
                }
            }
        }
    });
</script>


</div>

{% endblock %}
