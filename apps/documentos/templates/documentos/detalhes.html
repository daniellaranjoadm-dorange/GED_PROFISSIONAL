{% extends "documentos/base.html" %}
{% load static %}
{% load permisos %}

{% block title %}Detalhes do Documento{% endblock %}

{% block content %}

<style>
    /* ================================
       PALETA CORPORATIVA (AZUL PREMIUM)
    =================================== */
    :root {
        --primary: #0B5ED7;
        --primary-dark: #0948A8;
        --primary-soft: #E4EDFF;

        --accent: #F2790F;
        --accent-soft: #FFE3C6;

        --bg-page: #F4F6FA;
        --bg-card: #FFFFFF;

        --soft-border: #D8E0F0;
        --text-main: #1F2933;
        --text-muted: #6B7280;

        --row-highlight-bg: #E7F0FF;
    }

    /* Garante fundo limpo */
    body {
        background-color: var(--bg-page) !important;
        background-image: none !important;
    }

    /* Layout geral da página de detalhes */
    .doc-wrapper {
    width: 100%;
    max-width: 100%;
    margin-left: 0;
    padding: 0;
}


    /* Título principal tipo "Microsoft / Autodesk" */
    .doc-title-main {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: linear-gradient(90deg, #FFFFFF 0%, #F2F6FF 40%, #E7F0FF 100%);
        border-radius: 0.9rem;
        padding: 0.9rem 1.3rem;
        border: 1px solid #E1E7F5;
        color: var(--text-main);
        font-weight: 700;
        margin-bottom: 1.2rem;
        font-size: 1.35rem;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
    }

    .doc-title-main span.icon {
        font-size: 1.5rem;
    }

    /* Títulos de seção em "pílula premium" */
    .doc-section-title {
        display: inline-flex;
        align-items: center;
        gap: 0.55rem;
        padding: 0.4rem 0.95rem;
        border-radius: 999px;
        font-size: 1.05rem;
        font-weight: 600;
        color: var(--primary-dark);
        background: rgba(11, 94, 215, 0.10);
        margin-bottom: 0.9rem;
    }

    .doc-section-title span.icon {
        font-size: 1.1rem;
    }

    /* Cards corporativos */
    .doc-wrapper .card {
        border-radius: 1rem;
        border-color: var(--soft-border);
        background-color: var(--bg-card);
    }

    .doc-wrapper .card.shadow-sm {
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.05) !important;
    }

    /* Tabelas corporativas */
    .doc-wrapper .table {
        margin-bottom: 0;
        font-size: 0.9rem;
        color: var(--text-main);
    }

    .doc-wrapper .table thead tr {
        background: #F1F4FB;
    }

    .doc-wrapper .table thead th {
        border-bottom-width: 1px;
        font-weight: 600;
        color: #4A4F5C;
        text-transform: uppercase;
        font-size: 0.78rem;
        letter-spacing: 0.03em;
    }

    .doc-wrapper .table tbody tr:hover {
        background-color: #F8FAFE;
    }

    .doc-wrapper .table-bordered > :not(caption) > * > * {
        border-color: #D5DBE8;
    }

    .doc-wrapper .table td, .doc-wrapper .table th {
        vertical-align: middle;
    }

    /* Informações principais — cabeçalhos da tabela de metadados */
    .doc-wrapper .table-info th {
        width: 220px;
        background-color: #F6F8FE;
        color: #4A4F5C;
        font-weight: 600;
        border-right: 1px solid #E0E6F4;
    }

    .doc-wrapper .table-info td {
        background-color: #EFF5FF;
    }

    /* Destaque da versão atual no histórico */
    .doc-wrapper .table-versions tr.versao-atual {
        background: var(--row-highlight-bg) !important;
        border-left: 4px solid var(--primary);
    }

    .doc-wrapper .table-versions tr.versao-atual td:first-child strong {
        color: var(--primary-dark);
    }

    .badge-versao-atual,
    .badge.bg-primary {
        background-color: var(--primary) !important;
        color: #fff !important;
        font-size: 0.7rem;
        padding: 0.2rem 0.55rem;
        border-radius: 999px;
    }

    /* Badge de Anexo mais discreta */
    .badge.bg-secondary {
        background: #E5E7EB !important;
        color: #374151 !important;
        font-size: 0.7rem;
        border-radius: 999px;
    }

    /* Botões – estilo pill corporativo */
    .btn-pill {
        border-radius: 999px !important;
        font-weight: 500;
        padding-inline: 1.2rem;
    }

    .doc-wrapper .btn {
        font-size: 0.9rem;
    }

    .doc-wrapper .btn-primary {
        background-color: var(--primary);
        border-color: var(--primary);
        box-shadow: 0 4px 10px rgba(11, 94, 215, 0.35);
    }

    .doc-wrapper .btn-primary:hover,
    .doc-wrapper .btn-primary:focus {
        background-color: var(--primary-dark);
        border-color: var(--primary-dark);
    }

    .doc-wrapper .btn-outline-primary {
        border-radius: 999px;
        border-color: var(--primary);
        color: var(--primary);
    }

    .doc-wrapper .btn-outline-primary:hover {
        background-color: var(--primary);
        color: #fff;
    }

    .doc-wrapper .btn-outline-info {
        border-radius: 999px;
    }

    .doc-wrapper .btn-warning,
    .doc-wrapper .btn-success,
    .doc-wrapper .btn-info,
    .doc-wrapper .btn-secondary,
    .doc-wrapper .btn-dark,
    .doc-wrapper .btn-danger {
        border-radius: 999px;
    }

    /* Workflow histórico */
    .workflow-item strong {
        color: var(--primary-dark);
    }

    .workflow-item small {
        font-size: 0.78rem;
    }

    /* Modal comparar versões */
    #modalCompararVersoes .modal-header {
        border-bottom: 1px solid var(--soft-border);
    }

    #modalCompararVersoes .modal-body h6 {
        color: var(--primary-dark);
    }

    /* Texto auxiliar */
    .text-muted {
        color: var(--text-muted) !important;
    }

    /* ============================================
       PIPELINE DE WORKFLOW (C2)
    ============================================= */
    .wf-card {
        margin-bottom: 1.8rem;
    }

    .wf-header-label {
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--text-muted);
    }

    .wf-current-name {
        font-weight: 600;
        color: var(--primary-dark);
        font-size: 0.95rem;
    }

    .wf-pipeline {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: 0.5rem;
    }

    .wf-step {
        position: relative;
        flex: 1;
        text-align: center;
        font-size: 0.78rem;
        color: var(--text-muted);
        padding-top: 0.5rem;
    }

    .wf-step-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid #CBD5F5;
        background-color: #FFFFFF;
        margin: 0 auto 0.25rem;
        position: relative;
        z-index: 2;
    }

    .wf-step::before {
        content: "";
        position: absolute;
        top: 12px;
        left: 0;
        right: 0;
        height: 2px;
        background: #E5E7EB;
        z-index: 1;
    }

    .wf-step:first-child::before {
        left: 50%;
    }

    .wf-step:last-child::before {
        right: 50%;
    }

    .wf-step-label {
        display: block;
        margin-top: 0.1rem;
        white-space: nowrap;
    }

    .wf-step.done .wf-step-dot {
        background-color: var(--primary);
        border-color: var(--primary);
    }

    .wf-step.done .wf-step-label {
        color: var(--primary-dark);
        font-weight: 600;
    }

    .wf-step.current .wf-step-dot {
        background-color: #FFFFFF;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(242, 121, 15, 0.25);
    }

    .wf-step.current .wf-step-label {
        color: var(--primary-dark);
        font-weight: 700;
    }

    @media (max-width: 992px) {
        .wf-card .d-flex.flex-wrap {
            gap: 1rem;
        }
        .wf-step-label {
            font-size: 0.7rem;
        }
    }

    /* Responsividade geral */
    @media (max-width: 992px) {
        .doc-wrapper {
            padding-inline: 0;
        }

        .doc-title-main {
            font-size: 1.15rem;
            padding: 0.8rem 1rem;
        }

        .doc-wrapper .card {
            border-radius: 0.8rem;
        }

        .doc-wrapper .table {
            font-size: 0.84rem;
        }

        .doc-wrapper .btn {
            margin-bottom: 0.25rem;
        }
    }

    @media (max-width: 768px) {
        .doc-title-main {
            flex-direction: row;
            align-items: center;
        }
    }
</style>

<div class="doc-wrapper">

    <!-- TÍTULO PRINCIPAL -->
    <div class="doc-title-main">
        <span class="icon">📄</span>
        <span>Detalhes do Documento</span>
    </div>

    <!-- ============================================

    <!-- ============================================
         PIPELINE DE WORKFLOW + ETAPA ATUAL
    ============================================= -->
    <div class="card shadow-sm p-3 mb-4 wf-card">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">

            <div>
                <div class="wf-header-label">Etapa atual do workflow</div>
                <div class="wf-current-name">
                    {{ documento.etapa.nome|default:"Não definido" }}
                </div>
                <div class="small text-muted">
                    Código: {{ documento.codigo|default:"—"  }}
                </div>
            </div>

            <div class="flex-grow-1">
                <div class="wf-pipeline" id="wfPipeline">
                    <div class="wf-step" data-etapa="ELABORACAO">
                        <div class="wf-step-dot"></div>
                        <span class="wf-step-label">Elaboração</span>
                    </div>
                    <div class="wf-step" data-etapa="REVISAO_INTERNA">
                        <div class="wf-step-dot"></div>
                        <span class="wf-step-label">Revisão Interna</span>
                    </div>
                    <div class="wf-step" data-etapa="APROVACAO_TECNICA">
                        <div class="wf-step-dot"></div>
                        <span class="wf-step-label">Aprovação Técnica</span>
                    </div>
                    <div class="wf-step" data-etapa="DOC_CONTROL">
                        <div class="wf-step-dot"></div>
                        <span class="wf-step-label">Doc Control</span>
                    </div>
                    <div class="wf-step" data-etapa="ENVIADO_CLIENTE">
                        <div class="wf-step-dot"></div>
                        <span class="wf-step-label">Envio ao Cliente</span>
                    </div>
                    <div class="wf-step" data-etapa="APROVACAO_CLIENTE">
                        <div class="wf-step-dot"></div>
                        <span class="wf-step-label">Aprovação Cliente</span>
                    </div>
                    <div class="wf-step" data-etapa="EMISSAO_FINAL">
                        <div class="wf-step-dot"></div>
                        <span class="wf-step-label">Emissão Final</span>
                    </div>
                </div>
            </div>

            <div class="text-end">
                {% if pode_avancar_etapa %}
                    <button type="button"
                            class="btn btn-success btn-pill"
                            data-bs-toggle="modal"
                            data-bs-target="#modalAvancarEtapa">
                        ➜ Enviar para próxima etapa
                        {% if proxima_etapa %}
                            <div class="small text-white-50 mt-1">
                                Próxima: {{ proxima_etapa.nome|default:proxima_etapa }}
                            </div>
                        {% endif %}
                    </button>
                {% else %}
                    <button type="button"
                            class="btn btn-outline-secondary btn-pill"
                            disabled
                            title="Você não tem permissão para avançar esta etapa.">
                        ➜ Enviar para próxima etapa
                    </button>
                {% endif %}

                <div class="mt-2">
                    {% if pode_retornar_etapa %}
                        <button type="button"
                                class="btn btn-warning btn-pill"
                                data-bs-toggle="modal"
                                data-bs-target="#modalRetornarEtapa">
                            ⬅ Retornar etapa
                            {% if etapa_anterior %}
                                <div class="small text-dark mt-1">
                                    Etapa anterior: {{ etapa_anterior.nome|default:etapa_anterior }}
                                </div>
                            {% endif %}
                        </button>
                    {% else %}
                        <button type="button"
                                class="btn btn-outline-secondary btn-pill"
                                disabled
                                title="Você não tem permissão para retornar esta etapa.">
                            ⬅ Retornar etapa
                        </button>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>

    <!-- ✅ MODAL AVANÇAR ETAPA -->
    <div class="modal fade" id="modalAvancarEtapa" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form method="post"
                enctype="multipart/form-data"
                action="{% url 'documentos:enviar_proxima_etapa' documento.id %}">
            {% csrf_token %}

            <div class="modal-header bg-success text-white">
              <h5 class="modal-title fw-bold">➜ Avançar etapa — {{ documento.codigo }}</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label fw-bold">Motivo / Observação</label>
                <textarea name="observacao"
                          class="form-control"
                          rows="3"
                          required
                          placeholder="Descreva o motivo do avanço..."></textarea>
              </div>

              <div class="mb-2">
                <label class="form-label fw-bold">Anexos (opcional)</label>
                <input type="file"
                       name="anexos"
                       class="form-control"
                       multiple
                       accept=".pdf,.png,.jpg,.jpeg,.gif,.xlsx,.doc,.docx,.txt">
                <div class="small text-muted mt-1">
                  Você pode anexar fotos, PDFs e outros arquivos (múltiplos).
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary btn-pill" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-success btn-pill fw-bold">Confirmar avanço</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ✅ MODAL RETORNAR ETAPA -->
    <div class="modal fade" id="modalRetornarEtapa" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form method="post"
                enctype="multipart/form-data"
                action="{% url 'documentos:retornar_etapa' documento.id %}">
            {% csrf_token %}

            <div class="modal-header bg-warning">
              <h5 class="modal-title fw-bold">⬅ Retornar etapa — {{ documento.codigo }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label fw-bold">Motivo / Observação</label>
                <textarea name="observacao"
                          class="form-control"
                          rows="3"
                          required
                          placeholder="Explique por que está retornando a etapa..."></textarea>
              </div>

              <div class="mb-2">
                <label class="form-label fw-bold">Anexos (opcional)</label>
                <input type="file"
                       name="anexos"
                       class="form-control"
                       multiple
                       accept=".pdf,.png,.jpg,.jpeg,.gif,.xlsx,.doc,.docx,.txt">
                <div class="small text-muted mt-1">
                  Você pode anexar fotos, PDFs e outros arquivos (múltiplos).
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary btn-pill" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-warning btn-pill fw-bold">Confirmar retorno</button>
            </div>
          </form>
        </div>
      </div>
    </div>
         INFORMAÇÕES PRINCIPAIS
    
    <div class="card shadow-sm p-4 mb-4">
        <table class="table table-bordered mb-0 table-info">
            <tbody>
                <tr>
                    <th>Código</th>
                    <td>{{ documento.codigo }}</td>
                </tr>
                <tr>
                    <th>Revisão</th>
                    <td>{{ documento.revisao }}</td>
                </tr>
                <tr>
                    <th>Título</th>
                    <td>{{ documento.titulo }}</td>
                </tr>
                <tr>
                    <th>Projeto</th>
                    <td>{{ documento.projeto }}</td>
                </tr>
                <tr>
                    <th>Disciplina</th>
                    <td>{{ documento.disciplina }}</td>
                </tr>
                <tr>
                    <th>Tipo Documento</th>
                    <td>{{ documento.tipo_doc }}</td>
                </tr>
                <tr>
                    <th>Status Documento</th>
                    <td>{{ documento.status_documento }}</td>
                </tr>
                <tr>
                    <th>Status Emissão</th>
                    <td>{{ documento.status_emissao }}</td>
                </tr>
                <tr>

                </tr>
                <tr>
                    <th>Documento de Referencia</th>
                    <td>{{ documento.documento_Referencia }}</td>
                </tr>
                <tr>

                    <th>Data Emissão</th>
                    <td>
                        {% if documento.data_emissao_tp %}
                            {{ documento.data_emissao_tp|date:"d/m/Y" }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- ============================
         REVIS&Atilde;O ATUAL - PDF PRINCIPAL
    =============================== -->
    {% if versoes %}
        {% for v in versoes %}
            {% if v.numero_revisao == documento.revisao %}
                <h3 class="doc-section-title mt-4 mb-3">
                    <span class="icon">📄</span>
                    <span>Revisão Atual: {{ v.numero_revisao }}</span>
                </h3>

                <div class="card shadow-sm p-3 mb-4">
                    <div class="d-flex flex-wrap justify-content-between align-items-center">
                        <div class="mb-2">
                            <div class="fw-bold text-muted small">Arquivo principal</div>
                            <div class="fs-6">
                                {% if v.arquivo %}
                                    {{ v.arquivo.name|slice:"30" }}
                                {% else %}
                                    —
                                {% endif %}
                            </div>
                            <div class="small text-muted">
                                Criado por:
                                {% if v.criado_por %}
                                    {{ v.criado_por.get_full_name|default:v.criado_por.username }}
                                {% else %}
                                    —
                                {% endif %}
                                · {{ v.criado_em|date:"d/m/Y H:i" }}
                            </div>
                        </div>

                        <div class="d-flex flex-wrap gap-2">
                            {% if v.arquivo %}
                                <a href="{{ v.arquivo.url }}" target="_blank"
                                   class="btn btn-primary btn-pill">
                                    👁️ Visualizar PDF
                                </a>
                                <a href="{{ v.arquivo.url }}" download
                                   class="btn btn-outline-primary btn-pill">
                                    ⬇️ Baixar
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    <!-- ============================
         ANEXOS DO DOCUMENTO
         (Arquivos complementares)
    =============================== -->
    <h3 class="doc-section-title mt-4 mb-1">
        <span class="icon">📎</span>
        <span>Anexos do Documento</span>
    </h3>

    <p class="text-muted small mb-3">
        Estes arquivos são materiais complementares anexados ao documento.
        <strong>Não representam revisões técnicas.</strong>
    </p>

    <div class="card shadow-sm p-3 mb-4">

        <a href="{% url 'documentos:adicionar_arquivos' documento.id %}"
           class="btn btn-primary btn-pill mb-3">
            ➕ Enviar Arquivos
        </a>

        {% if anexos %}
            <table class="table table-striped table-bordered align-middle text-center mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Nome</th>
                        <th>Tipo</th>
                        <th>Visualização</th>
                        <th>Ações</th>
                    </tr>
                </thead>

                <tbody>
                    {% for a in anexos %}
                        <tr>
                            <td>
                                {{ a.nome_original }}
                                <span class="badge bg-secondary ms-1">Anexo</span>
                            </td>

                            <td>{{ a.tipo|default:"—" }}</td>

                            <td>
                                <a href="{{ a.arquivo.url }}"
                                   class="btn btn-outline-info btn-sm btn-pill"
                                   target="_blank">
                                    👁️ Abrir
                                </a>
                            </td>

                            <td>
                                <a href="{% url 'documentos:excluir_arquivo' a.id %}"
                                   class="btn btn-danger btn-sm btn-pill"
                                   onclick="return confirm('Excluir arquivo?')">
                                    🗑 Excluir
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>

            </table>

        {% else %}
            <p class="text-muted mb-0">Nenhum arquivo enviado.</p>
        {% endif %}
    </div>

    <!-- ============================
         BOTÕES COM RBAC
    =============================== -->
    <div class="mb-5 d-flex flex-wrap gap-2">

        <a href="{% url 'documentos:listar_documentos' %}"
           class="btn btn-secondary btn-pill">
           ← Voltar
        </a>

        {% if user|has_perm:"documento.editar" %}
            <a href="{% url 'documentos:editar_documento' documento.id %}"
               class="btn btn-warning btn-pill">
               ✏️ Editar
            </a>
        {% else %}
            <button class="btn btn-warning btn-pill" disabled title="Sem permissão">
                ✏️ Editar
            </button>
        {% endif %}

        {% if user|has_perm:"documento.revisar" %}
            <a href="{% url 'documentos:nova_revisao' documento.id %}"
               class="btn btn-info btn-pill">
               🔄 Nova Revisão
            </a>
            <button class="btn btn-primary btn-pill"
                    data-bs-toggle="modal"
                    data-bs-target="#modalNovaVersao">
                📄 Nova Versão
            </button>
            <button type="button"
                    id="btnCompararVersoesGlobal"
                    class="btn btn-outline-info btn-pill">
                🔍 Comparar Versões
            </button>
        {% else %}
            <button class="btn btn-info btn-pill" disabled title="Sem permissão">
               🔄 Nova Revisão
            </button>
        {% endif %}

        {% if user|has_perm:"documento.aprovar" %}
            <a href="{% url 'documentos:aprovar_documento' documento.id %}"
               class="btn btn-primary btn-pill">
                👍 Aprovar
            </a>
        {% else %}
            <button class="btn btn-primary btn-pill" disabled title="Sem permissão">
                👍 Aprovar
            </button>
        {% endif %}

        {% if user|has_perm:"documento.emitir" %}
            <a href="{% url 'documentos:emitir_documento' documento.id %}"
               class="btn btn-success btn-pill">
                📤 Emitir
            </a>
        {% else %}
            <button class="btn btn-success btn-pill" disabled title="Sem permissão">
                📤 Emitir
            </button>
        {% endif %}

        {% if user|has_perm:"documento.cancelar" %}
            <a href="{% url 'documentos:cancelar_documento' documento.id %}"
               class="btn btn-dark btn-pill">
                ✖ Cancelar
            </a>
        {% else %}
            <button class="btn btn-dark btn-pill" disabled title="Sem permissão">
                ✖ Cancelar
            </button>
        {% endif %}

        {% if user|has_perm:"documento.excluir" %}
            <a href="{% url 'documentos:excluir_documento' documento.id %}"
               class="btn btn-danger btn-pill"
               onclick="return confirm('Tem certeza que deseja excluir este DOCUMENTO?')">
                🗑️ Excluir Documento
            </a>
        {% else %}
            <button class="btn btn-danger btn-pill" disabled title="Sem permissão">
                🗑️ Excluir Documento
            </button>
        {% endif %}

    </div>

    <!-- ============================
         WORKFLOW – HISTÓRICO
    =============================== -->
    <h3 class="doc-section-title mt-4 mb-3">
        <span class="icon">⭐</span>
        <span>Workflow – Histórico</span>
    </h3>

    <div class="card shadow-sm p-3 mb-4">
        {% if historico_workflow %}
            <ul class="list-group mb-0">
                {% for wf in historico_workflow %}
                    <li class="list-group-item workflow-item">
                        <strong>{{ wf.etapa }}</strong> — {{ wf.status }}
                        <br>
                        Usuário: {{ wf.usuario }}
                        <br>
                        <small class="text-muted">{{ wf.data|date:"d/m/Y H:i" }}</small>

                        {% if wf.observacao %}
                            <div class="mt-2 text-warning">
                                <strong>Obs:</strong> {{ wf.observacao }}
                            </div>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted mb-0">Nenhum histórico encontrado.</p>
        {% endif %}
    </div>

    <!-- ============================
         HISTÓRICO DE REVISÕES
    =============================== -->
    <h3 class="doc-section-title mt-4 mb-3">
        <span class="icon">📘</span>
        <span>Histórico de Revisões</span>
    </h3>

    <div class="card shadow-sm p-3 mb-4">

        {% if versoes %}
        <table class="table table-striped table-bordered align-middle mb-0 table-versions">
            <thead class="table-light">
                <tr>
                    <th>Revisão</th>
                    <th>Arquivo</th>
                    <th>Criado por</th>
                    <th>Data</th>
                    <th>Observação</th>
                </tr>
            </thead>
            <tbody>

                <!-- REVIS&Atilde;O ATUAL NO TOPO -->
                {% for v in versoes %}
                    {% if v.numero_revisao == documento.revisao %}
                    <tr class="versao-atual"
                        data-arquivo="{% if v.arquivo %}{{ v.arquivo.url }}{% endif %}"
                        data-revisao="{{ v.numero_revisao }}">

                        <td>
                            <strong>{{ v.numero_revisao }}</strong>
                            <span class="badge bg-primary ms-1">Atual</span>
                        </td>
                        <td>
                            {% if v.arquivo %}
                                <a href="{{ v.arquivo.url }}" class="btn btn-outline-primary btn-sm btn-pill" download>
                                    ⬇️ Baixar
                                </a>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if v.criado_por %}
                                {{ v.criado_por.get_full_name|default:v.criado_por.username }}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td>{{ v.criado_em|date:"d/m/Y H:i" }}</td>
                        <td>{{ v.observacao|default:"—" }}</td>

                    </tr>
                    {% endif %}
                {% endfor %}

                <!-- REVISÕES ANTERIORES ABAIXO -->
                {% for v in versoes %}
                    {% if v.numero_revisao != documento.revisao %}
                    <tr
                        {% if v.arquivo %}data-arquivo="{{ v.arquivo.url }}"{% endif %}
                        data-revisao="{{ v.numero_revisao }}"
                    >
                        <td><strong>{{ v.numero_revisao }}</strong></td>

                        <td>
                            {% if v.arquivo %}
                                <a href="{{ v.arquivo.url }}" class="btn btn-outline-primary btn-sm btn-pill" download>
                                    ⬇️ Baixar
                                </a>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>

                        <td>
                            {% if v.criado_por %}
                                {{ v.criado_por.get_full_name|default:v.criado_por.username }}
                            {% else %}
                                —
                            {% endif %}
                        </td>

                        <td>{{ v.criado_em|date:"d/m/Y H:i" }}</td>
                        <td>{{ v.observacao|default:"—" }}</td>

                    </tr>
                    {% endif %}
                {% endfor %}

            </tbody>
        </table>

        {% else %}
            <p class="text-muted mb-0">Nenhuma revisão registrada.</p>
        {% endif %}
    </div>

    <!-- ======================================================
         MODAL — NOVA VERS&Atilde;O DO DOCUMENTO
    ====================================================== -->
    <div class="modal fade" id="modalNovaVersao" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">

                <form method="POST" enctype="multipart/form-data"
                      action="{% url 'documentos:nova_versao' documento.id %}">
                    {% csrf_token %}

                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title fw-bold">📄 Nova Versão — {{ documento.codigo }}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">

                        <div class="mb-3">
                            <label class="form-label fw-bold">Número da Revisão</label>
                            <input type="text" name="numero_revisao" class="form-control"
                                   value="{{ proxima_revisao }}" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Arquivo da Nova Versão</label>
                            <input type="file" name="arquivo" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Observações da Revisão</label>
                            <textarea name="observacao" class="form-control" rows="3"
                                      placeholder="Descreva as alterações realizadas..."></textarea>
                        </div>

                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-pill"
                                data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success btn-pill fw-bold">
                            💾 Salvar Nova Versão
                        </button>
                    </div>

                </form>

            </div>
        </div>
    </div>

    <!-- ======================================================
         MODAL — COMPARAR VERSÕES (GLOBAL)
    ====================================================== -->
    <div class="modal fade" id="modalCompararVersoes" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
          <div class="modal-content">
      
            <div class="modal-header bg-secondary text-white">
              <h5 class="modal-title fw-bold">
                🔍 Comparar Versões
                <span id="tituloVersoesComparadas" class="ms-2"></span>
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
      
            <div class="modal-body">
      
              <!-- DROPDOWNS DE COMPARAÇ&Atilde;O -->
              <div class="row mb-3">
      
                  <div class="col-md-5">
                      <label class="fw-bold">Revisão A</label>
                      <select class="form-select" id="selectRevA">
                          {% for v in versoes %}
                              <option value="{{ v.numero_revisao }}">{{ v.numero_revisao }}</option>
                          {% endfor %}
                      </select>
                  </div>
      
                  <div class="col-md-5">
                      <label class="fw-bold">Revisão B</label>
                      <select class="form-select" id="selectRevB">
                          {% for v in versoes %}
                              <option value="{{ v.numero_revisao }}">{{ v.numero_revisao }}</option>
                          {% endfor %}
                      </select>
                  </div>
      
                  <div class="col-md-2 d-flex align-items-end">
                      <button class="btn btn-primary w-100 btn-pill" id="btnCompararDrop">
                          🔍 Comparar
                      </button>
                  </div>
      
              </div>
      
              <!-- IFRAMES LADO A LADO -->
              <div class="row g-3">
                <div class="col-md-6">
                  <h6 class="fw-bold">Versão anterior</h6>
                  <div class="border" style="height:70vh;">
                    <iframe id="iframeVersaoAnterior"
                            src=""
                            style="width:100%; height:100%; border:0;"
                            loading="lazy">
                    </iframe>
                  </div>
                </div>
                <div class="col-md-6">
                  <h6 class="fw-bold">Versão atual</h6>
                  <div class="border" style="height:70vh;">
                    <iframe id="iframeVersaoAtual"
                            src=""
                            style="width:100%; height:100%; border:0;"
                            loading="lazy">
                    </iframe>
                  </div>
                </div>
              </div>
      
            </div>
      
            <div class="modal-footer">
      
              <button class="btn btn-primary btn-pill" id="btnGerarDiff">
                  📄 Gerar PDF Diff
              </button>
          
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                  Fechar
              </button>
          
            </div>
      
          </div>
        </div>
    </div>

</div>  {# fim .doc-wrapper #}

<!-- ======================================================
     JS — PIPELINE DE WORKFLOW (C2)
====================================================== -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const atual = "{{ documento.etapa_atual|default:''|escapejs }}";
    const steps = document.querySelectorAll("#wfPipeline .wf-step");
    if (!steps.length || !atual) return;

    let currentIndex = -1;
    steps.forEach((step, idx) => {
        if (step.dataset.etapa === atual) {
            currentIndex = idx;
        }
    });

    steps.forEach((step, idx) => {
        if (currentIndex === -1) return;
        if (idx < currentIndex) {
            step.classList.add("done");
        } else if (idx === currentIndex) {
            step.classList.add("current");
        }
    });
});
</script>

<!-- ======================================================
     JS — COMPARAR VERSÕES (BOT&Atilde;O GLOBAL)
====================================================== -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    var btn = document.getElementById("btnCompararVersoesGlobal");
    if (!btn) return;

    btn.addEventListener("click", function () {
        var rows = Array.prototype.slice.call(
            document.querySelectorAll("table tbody tr[data-arquivo]")
        ).filter(function (tr) {
            return tr.getAttribute("data-arquivo") && tr.getAttribute("data-arquivo") !== "";
        });

        if (rows.length < 2) {
            alert("É necessário ter pelo menos 2 versões com arquivo para comparar.");
            return;
        }

        var atualRow = document.querySelector("tr.versao-atual[data-arquivo]") || rows[0];
        var anteriorRow = null;

        if (atualRow === rows[0]) {
            anteriorRow = rows[1];
        } else {
            anteriorRow = rows[0];
        }

        var urlAtual = atualRow.getAttribute("data-arquivo");
        var revAtual = atualRow.getAttribute("data-revisao");
        var urlAnterior = anteriorRow.getAttribute("data-arquivo");
        var revAnterior = anteriorRow.getAttribute("data-revisao");

        var iframeAnterior = document.getElementById("iframeVersaoAnterior");
        var iframeAtual = document.getElementById("iframeVersaoAtual");
        var titulo = document.getElementById("tituloVersoesComparadas");

        if (iframeAnterior) iframeAnterior.src = urlAnterior || "";
        if (iframeAtual) iframeAtual.src = urlAtual || "";

        if (titulo) {
            titulo.textContent = "(Rev. " + (revAnterior || "?") + " × Rev. " + (revAtual || "?") + ")";
        }

        var modalEl = document.getElementById("modalCompararVersoes");
        if (modalEl && window.bootstrap && bootstrap.Modal) {
            var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
        }
    });

    var modalEl = document.getElementById("modalCompararVersoes");
    if (modalEl) {
        modalEl.addEventListener("hidden.bs.modal", function () {
            var iframeAnterior = document.getElementById("iframeVersaoAnterior");
            var iframeAtual = document.getElementById("iframeVersaoAtual");
            if (iframeAnterior) iframeAnterior.src = "";
            if (iframeAtual) iframeAtual.src = "";
        });
    }
});
</script>

<!-- ======================================================
     JS — COMPARAR REVISÕES ESPECÍFICAS (DROPDOWNS)
====================================================== -->
<script>
document.getElementById("btnCompararDrop").addEventListener("click", function () {

    const revA = document.getElementById("selectRevA").value;
    const revB = document.getElementById("selectRevB").value;

    if (!revA || !revB) {
        alert("Selecione as duas revisões.");
        return;
    }

    if (revA === revB) {
        alert("Selecione revisões diferentes.");
        return;
    }

    // Localiza as revisões na tabela
    const rowA = document.querySelector(`tr[data-revisao='${revA}']`);
    const rowB = document.querySelector(`tr[data-revisao='${revB}']`);

    if (!rowA || !rowB) {
        alert("Não foi possível localizar as revisões selecionadas.");
        return;
    }

    const urlA = rowA.getAttribute("data-arquivo");
    const urlB = rowB.getAttribute("data-arquivo");

    if (!urlA || !urlB) {
        alert("Uma das revisões selecionadas não possui arquivo PDF.");
        return;
    }

    // Atualiza iframes
    document.getElementById("iframeVersaoAnterior").src = urlA;
    document.getElementById("iframeVersaoAtual").src = urlB;

    // Atualiza o título
    document.getElementById("tituloVersoesComparadas").textContent =
        "(Rev. " + revA + " × Rev. " + revB + ")";
});
</script>

<!-- ======================================================
     JS — GERAR PDF DIFF
====================================================== -->
<script>
document.getElementById("btnGerarDiff").addEventListener("click", function () {

    const titulo = document.getElementById("tituloVersoesComparadas").textContent;

    const match = titulo.match(/Rev\. ([^ ]+)\s*×\s*Rev\. ([^)]+)/);

    if (!match) {
        alert("Não foi possível identificar as revisões.");
        return;
    }

    const revA = match[1].trim();
    const revB = match[2].trim();
    const documentoId = "{{ documento.id }}";

    fetch(`/gerar-diff/${documentoId}/${revA}/${revB}/`)
        .then(response => response.json())
        .then(data => {
            if (data.status === "ok") {
                window.open(data.diff_url, "_blank");
            } else {
                alert("Erro ao gerar comparação de PDF.");
            }
        })
        .catch(err => {
            console.error(err);
            alert("Erro inesperado ao gerar PDF Diff.");
        });

});
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const pipeline = document.getElementById("wfPipeline");
    if (!pipeline) return;

    const atual = "{{ documento.etapa.codigo|default:documento.etapa_atual|default:''|escapejs }}".trim();
    if (!atual) return;

    const steps = Array.from(pipeline.querySelectorAll(".wf-step"));
    let passed = true;

    steps.forEach((step) => {
        const codigo = (step.getAttribute("data-etapa") || "").trim();
        if (!codigo) return;

        if (passed && codigo !== atual) {
            step.classList.add("done");
        } else if (codigo === atual) {
            step.classList.add("current");
            passed = false;
        }
    });
});
</script>
{% endblock %}
